<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multiplayer Quiz Spiel</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-indigo-600 to-purple-700 min-h-screen flex justify-center items-center text-white">
  <div id="root" class="w-full"></div>

  <script type="text/babel">

    const { useState, useEffect } = React;

    // --- Firebase Setup ---
    const firebaseConfig = {
        apiKey: "AIzaSyCsxAEsivsJVFVcnerdAWezFpruoCv7Z2I",
            authDomain: "qiuz-64055.firebaseapp.com",
            databaseURL: "https://qiuz-64055-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "qiuz-64055",
            storageBucket: "qiuz-64055.firebasestorage.app",
            messagingSenderId: "605853616985",
            appId: "1:605853616985:web:95579b246a10d89ba51a48"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Beispiel-Fragen ---
    const QUESTIONS = [
      { q: "Was ist die Hauptstadt von Deutschland?", a: ["Berlin", "M√ºnchen", "Hamburg", "K√∂ln"], c: 0 },
      { q: "Wie viele Kontinente gibt es?", a: ["5", "6", "7", "8"], c: 2 },
      { q: "Was ist 9 √ó 9?", a: ["72", "81", "99", "108"], c: 1 },
    ];

    // --- Utility: zuf√§llige ID ---
    const randomID = () => Math.random().toString(36).substr(2, 6).toUpperCase();

    // --- Startbildschirm ---
    function StartScreen({ onCreate, onJoin }) {
      const [name, setName] = useState("");
      const [code, setCode] = useState("");

      return (
        <div className="text-center">
          <h1 className="text-5xl font-bold mb-8">üéÆ Quiz Spiel</h1>
          <input
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="Dein Name"
            className="px-4 py-2 rounded text-black mb-4 w-60"
          /><br/>
          <button
            onClick={() => name && onCreate(name)}
            className="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-lg font-bold mr-4"
          >
            Neues Spiel
          </button>
          <br /><br />
          <input
            value={code}
            onChange={(e) => setCode(e.target.value.toUpperCase())}
            placeholder="Spielcode eingeben"
            className="px-4 py-2 rounded text-black mb-4 w-60"
          /><br/>
          <button
            onClick={() => name && code && onJoin(name, code)}
            className="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-lg font-bold"
          >
            Beitreten
          </button>
        </div>
      );
    }

    // --- Lobby ---
    function Lobby({ game, playerName, isHost, onStart }) {
      const [players, setPlayers] = useState([]);

      useEffect(() => {
        const ref = db.ref(`games/${game}/players`);
        ref.on("value", snap => {
          const val = snap.val() || {};
          setPlayers(Object.keys(val));
        });
        return () => ref.off();
      }, [game]);

      return (
        <div className="text-center">
          <h1 className="text-4xl font-bold mb-4">üë• Lobby</h1>
          <p className="mb-2 text-xl">Spielcode: <span className="font-mono bg-white text-black px-2 py-1 rounded">{game}</span></p>
          <p className="text-lg mb-6">Warte auf Spieler...</p>
          <div className="bg-white text-black rounded-xl p-4 max-w-sm mx-auto mb-6">
            {players.map((p, i) => (
              <div key={i} className="py-1">{p}{p === playerName ? " (Du)" : ""}</div>
            ))}
          </div>
          {isHost && (
            <button
              onClick={onStart}
              className="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-lg font-bold"
            >
              Spiel starten
            </button>
          )}
        </div>
      );
    }

    // --- Quiz ---
    function Quiz({ game, playerName, isHost }) {
      const [questionIndex, setQuestionIndex] = useState(0);
      const [selected, setSelected] = useState(null);
      const [scores, setScores] = useState({});
      const current = QUESTIONS[questionIndex];

      useEffect(() => {
        const ref = db.ref(`games/${game}/state`);
        ref.on("value", snap => {
          const val = snap.val();
          if (val && typeof val.questionIndex === "number") setQuestionIndex(val.questionIndex);
        });
        const scoreRef = db.ref(`games/${game}/scores`);
        scoreRef.on("value", snap => setScores(snap.val() || {}));
        return () => { ref.off(); scoreRef.off(); };
      }, [game]);

      const handleAnswer = (i) => {
        setSelected(i);
        const correct = i === current.c;
        db.ref(`games/${game}/scores/${playerName}`).transaction(s => (s || 0) + (correct ? 100 : 0));
        setTimeout(() => {
          setSelected(null);
          if (isHost && questionIndex < QUESTIONS.length - 1) {
            db.ref(`games/${game}/state`).update({ questionIndex: questionIndex + 1 });
          } else if (isHost && questionIndex === QUESTIONS.length - 1) {
            db.ref(`games/${game}/state`).update({ finished: true });
          }
        }, 1000);
      };

      const [finished, setFinished] = useState(false);
      useEffect(() => {
        const ref = db.ref(`games/${game}/state/finished`);
        ref.on("value", snap => setFinished(!!snap.val()));
        return () => ref.off();
      }, [game]);

      if (finished) {
        const sorted = Object.entries(scores).sort((a,b) => b[1]-a[1]);
        return (
          <div className="text-center">
            <h1 className="text-5xl font-bold mb-8">üèÜ Endstand</h1>
            <div className="bg-white text-black rounded-xl p-4 max-w-sm mx-auto">
              {sorted.map(([name, score], i) => (
                <div key={i} className="py-1 text-lg">{i+1}. {name} ‚Äì {score} Punkte</div>
              ))}
            </div>
          </div>
        );
      }

      return (
        <div className="bg-white text-black rounded-2xl p-8 shadow-2xl max-w-xl mx-auto">
          <h1 className="text-2xl font-bold mb-6 text-center">Frage {questionIndex + 1}</h1>
          <p className="text-lg mb-6 text-center">{current.q}</p>
          <div className="grid gap-4">
            {current.a.map((ans, i) => (
              <button
                key={i}
                onClick={() => handleAnswer(i)}
                disabled={selected !== null}
                className={`p-3 rounded-lg font-bold transition 
                  ${selected === null ? "bg-blue-500 hover:bg-blue-600 text-white"
                    : i === current.c ? "bg-green-500 text-white"
                    : i === selected ? "bg-red-500 text-white"
                    : "bg-gray-300 text-gray-600"}`}
              >
                {ans}
              </button>
            ))}
          </div>
          <p className="text-center text-gray-600 mt-6 font-semibold">Dein Punktestand: {scores[playerName] || 0}</p>
        </div>
      );
    }

    // --- Hauptkomponente ---
    function App() {
      const [stage, setStage] = useState("start");
      const [gameID, setGameID] = useState("");
      const [playerName, setPlayerName] = useState("");
      const [isHost, setIsHost] = useState(false);

      const createGame = (name) => {
        const id = randomID();
        db.ref(`games/${id}`).set({
          host: name,
          state: { questionIndex: 0, finished: false },
          players: { [name]: true },
          scores: {}
        });
        setGameID(id);
        setPlayerName(name);
        setIsHost(true);
        setStage("lobby");
      };

      const joinGame = (name, id) => {
        const ref = db.ref(`games/${id}/players/${name}`);
        ref.set(true);
        setGameID(id);
        setPlayerName(name);
        setIsHost(false);
        setStage("lobby");
      };

      const startGame = () => {
        db.ref(`games/${gameID}/state`).update({ questionIndex: 0 });
        setStage("quiz");
      };

      if (stage === "start") return <StartScreen onCreate={createGame} onJoin={joinGame} />;
      if (stage === "lobby") return <Lobby game={gameID} playerName={playerName} isHost={isHost} onStart={startGame} />;
      if (stage === "quiz") return <Quiz game={gameID} playerName={playerName} isHost={isHost} />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

