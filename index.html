<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTL AdAlliance Quiz - Multiplayer</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind utilities -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --rtl-orange:#FF6600;
      --rtl-red:#E31F23;
      --rtl-purple:#7B2CBF;
      --rtl-green:#22C55E;
      --bg:#0b0b0b;
      --panel:#0f0f0f;
      --tile:#ffffff;
      --muted:rgba(255,255,255,0.65);
    }
    
    html,body,#root{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{ background:linear-gradient(180deg,var(--bg), #090909); color:var(--tile); }
    * { box-sizing:border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    input, textarea, select { background: white !important; color: #0b0b0b !important; border: 1px solid rgba(0,0,0,0.1); padding: 8px; border-radius:6px; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; font-weight:800; padding:12px 18px; cursor:pointer; border:none; border-radius:10px; background:rgba(255,255,255,0.03); color:var(--tile); font-size:16px; }
    .btn-host{ background:var(--rtl-orange); color:white; }
    .btn-join{ background:var(--rtl-purple); color:white; }
    .btn-pause{ background:#FFD700; border: 2px solid #FFA500; color:#000; font-weight:900; }
    .btn-show-results{
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
      color: var(--tile);
    }
    .card{ padding:20px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.03); border-radius:12px; }
    .host-screen{ display:flex; gap:20px; padding:20px; height:100vh; align-items:stretch; overflow:hidden; }
    .host-main{ flex:2; padding:24px; display:flex; flex-direction:column; gap:16px; min-height:0; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); border-radius:12px; overflow:auto; }
    .host-side{ flex:1; padding:20px; overflow:auto; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); border-radius:12px; max-height:100%; }
    .countdown-badge{ width:110px; height:110px; display:flex; align-items:center; justify-content:center; font-size:2.6rem; font-weight:800; color:var(--tile); border:3px solid rgba(255,255,255,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); flex-shrink:0; border-radius:14px; }
    .countdown-badge.warning{ border-color:var(--rtl-orange); color:var(--rtl-orange); }
    .countdown-badge.danger{ border-color:var(--rtl-red); color:var(--rtl-red); box-shadow:0 6px 30px rgba(227,31,35,0.09); transform-origin:center; animation:pulse 1s infinite; }
    @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)} }
    .answers-grid{ display:grid; grid-template-columns:repeat(2, 1fr); gap:16px; margin-top:16px; }
    .answer-btn{ background: #ffffff; color:#0b0b0b; padding:20px; font-size:1.1rem; font-weight:700; min-height:100px; display:flex; align-items:center; gap:12px; border-radius:10px; }
    .item-bar{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .item-btn{ padding:6px 10px; font-weight:800; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); cursor:pointer; color:var(--tile); display:flex; gap:6px; align-items:center; min-width:60px; justify-content:center; border-radius:8px; font-size:13px; }
    .item-btn.item-disabled{ opacity:0.35; cursor:not-allowed; }
    .item-btn.active { background: linear-gradient(90deg, #fff3cc, #ffd580); color: #000; }
    .item-btn.shield-active { background: linear-gradient(90deg, #dbeeff, #8ec5ff); color: #000; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.75); display:flex; align-items:center; justify-content:center; z-index:9999; padding:16px; }
    .modal-card{ width:95%; max-width:480px; background:linear-gradient(180deg,#0f0f0f,#0b0b0b); border:1px solid rgba(255,255,255,0.06); padding:16px; color:var(--tile); box-shadow: 0 10px 40px rgba(0,0,0,0.6); border-radius:12px; }
    .host-main.fullwidth{ width:100%; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: .3s; border-radius: 26px; }
    .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: var(--rtl-orange); }
    input:checked + .toggle-slider:before { transform: translateX(24px); }
    
    @media (max-width:600px){ 
      .answers-grid{ grid-template-columns:1fr; } 
      .countdown-badge{ width:70px;height:70px;font-size:1.6rem; } 
      .host-screen{ flex-direction:column; padding:10px; }
      .host-side{ order:2; }
      .host-main{ order:1; }
    }
    @media (max-width:420px){
      .modal-card{ max-width:340px; padding:14px; border-radius:12px; }
      .btn{ padding:10px 12px; border-radius:10px; font-size:14px; }
    }

    * { border-radius: 0 !important; }   

    /* TV scaling */
    @media (min-width: 1400px) {
      .host-main, .host-side {
        font-size: 1.4rem !important;
      }
      .host-main h2 {
        font-size: 2.6rem !important;
      }
      .host-main h3 {
        font-size: 2rem !important;
      }
      .answers-grid .answer-btn {
        font-size: 1.5rem !important;
        padding: 28px !important;
        min-height: 140px !important;
      }
      .countdown-badge {
        width: 150px !important;
        height: 150px !important;
        font-size: 3.5rem !important;
      }
      .btn {
        font-size: 1.2rem !important;
        padding: 14px 22px !important;
      }
    }

    .host-main h2, 
    .host-main h3,
    .host-main h1,
    .answers-grid .answer-btn {
      line-height: 1.3 !important;
    }

    .countdown-badge {
      text-shadow: 0 4px 12px rgba(0,0,0,0.8);
    }
    
    .action-log-item {
      padding: 10px 12px;
      background: rgba(255,255,255,0.02);
      border-left: 3px solid rgba(255,255,255,0.1);
      margin-bottom: 8px;
      font-size: 14px;
    }
    .action-log-item.boost { border-left-color: #ffd580; }
    .action-log-item.poison { border-left-color: #ff6b6b; }
    .action-log-item.shield { border-left-color: #8ec5ff; }
    .action-log-item.trade { border-left-color: #22C55E; }

    .scrollable-section {
      max-height: 200px;
      overflow-y: auto;
    }

    .compact-grid {
      display: grid;
      gap: 6px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /************ CONFIG ************/
  const TOTAL_ROUNDS = 4;
  const QUESTIONS_PER_ROUND = 2;
  const QUESTION_TIME = 40;
  const BASE_POINTS = 100;
  const CATEGORY_CHOOSER_BONUS = 1.2;
  const FINAL_QUESTIONS = 5;
  const FINAL_TIME = 60;
  const FINAL_POINTS = 200;

  const firebaseConfig = {
    apiKey: "AIzaSyCsxAEsivsJVFVcnerdAWezFpruoCv7Z2I",
    authDomain: "qiuz-64055.firebaseapp.com",
    databaseURL: "https://qiuz-64055-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "qiuz-64055",
    storageBucket: "qiuz-64055.firebasedatabase.app",
    messagingSenderId: "605853616985",
    appId: "1:605853616985:web:95579b246a10d89ba51a48"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /************ Kategorien & Fragen ************/
  const CATEGORY_LIST = ["Geografie", "Wissenschaft", "Geschichte", "Kultur & Kunst", "Sport", "Technik & Digitalisierung"];
  
  const QUESTION_POOL = [
    { question: "Welches Land hat die l√§ngste K√ºstenlinie der Welt?", answers: ["USA","Kanada","Australien","Indonesien"], correct: 1, category: "Geografie" },
    { question: "Welche Stadt liegt am Bosporus?", answers: ["Belgrad","Istanbul","Athen","Sofia"], correct: 1, category: "Geografie" },
    { question: "Wie viele Chromosomen hat der Mensch normalerweise?", answers: ["42","44","46","48"], correct: 2, category: "Wissenschaft" },
    { question: "Welches Gas atmen wir haupts√§chlich ein?", answers: ["Sauerstoff","Stickstoff","Kohlendioxid","Helium"], correct: 1, category: "Wissenschaft" },
    { question: "Wer war der erste Kanzler der Bundesrepublik Deutschland?", answers: ["Brandt","Schmidt","Adenauer","Kohl"], correct: 2, category: "Geschichte" },
    { question: "In welchem Jahr begann der Zweite Weltkrieg?", answers: ["1938","1939","1940","1941"], correct: 1, category: "Geschichte" },
    { question: "Wer komponierte die 9. Sinfonie?", answers: ["Beethoven","Mozart","Bach","Haydn"], correct: 0, category: "Kultur & Kunst" },
    { question: "Welcher K√ºnstler schuf die 'Sternennacht'?", answers: ["Monet","Van Gogh","Gauguin","Da Vinci"], correct: 1, category: "Kultur & Kunst" },
    { question: "Wie viele Spieler hat eine Fu√üballmannschaft auf dem Feld?", answers: ["9","10","11","12"], correct: 2, category: "Sport" },
    { question: "Wer gewann die Fu√üball-WM 2014?", answers: ["Brasilien","Deutschland","Spanien","Argentinien"], correct: 1, category: "Sport" },
    { question: "Was bedeutet die Abk√ºrzung 'CPU'?", answers: ["Central Performance Unit","Central Processing Unit","Computer Personal Unit","Control Processing Unit"], correct: 1, category: "Technik & Digitalisierung" },
    { question: "Welche Firma entwickelte das erste iPhone?", answers: ["Samsung","Apple","Nokia","Motorola"], correct: 1, category: "Technik & Digitalisierung" },
  ];

  const FINAL_QUESTION_POOL = [
    { question: "In welchem Jahr wurde die Berliner Mauer errichtet?", answer: "1961" },
    { question: "Wie hei√üt der h√∂chste Berg Deutschlands?", answer: "Zugspitze" },
    { question: "Welches chemische Element hat das Symbol 'Au'?", answer: "Gold" },
    { question: "Wie viele Bundesl√§nder hat Deutschland?", answer: "16" },
    { question: "In welcher Stadt steht die Freiheitsstatue?", answer: "New York" },
    { question: "Welcher Planet ist der Sonne am n√§chsten?", answer: "Merkur" },
    { question: "Wie viele Tasten hat ein Standardklavier?", answer: "88" },
    { question: "Welches Jahr markiert den Beginn des Ersten Weltkriegs?", answer: "1914" },
  ];

  function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function randomGameID(){ return Math.random().toString(36).substr(2,6).toUpperCase(); }
  function makePlayerId(){ return Date.now().toString(36) + Math.random().toString(36).substr(2,4); }

  function getQuestionsForCategory(category, count, usedQuestions = []) {
    let pool = QUESTION_POOL.filter(q => q.category === category && !usedQuestions.includes(q.question));
    
    if (pool.length < count) {
      const fallbackPool = QUESTION_POOL.filter(q => !usedQuestions.includes(q.question));
      if (fallbackPool.length > 0) {
        pool = fallbackPool;
      } else {
        pool = QUESTION_POOL.filter(q => q.category === category);
      }
    }
    
    pool = shuffle(pool).slice(0, count);
    return pool.map((q, idx) => ({ 
      id: `${category}-${Date.now()}-${Math.random().toString(36).substr(2,5)}-${idx}`, 
      ...q 
    }));
  }

  const DEFAULT_ITEMS = { boost: 5, poison: 5, shield: 3 };

  function RTLLogo({ size = "md" }) {
    const sizeMap = { sm: 40, md: 60, lg: 100 };
    const height = sizeMap[size] || 60;
    return (
      <img 
        src="Logo.png"
        alt="Logo"
        style={{ height, width: "auto" }}
      />
    );
  }

  function qrUrlForGame(gameId){
    const url = `${window.location.origin}${window.location.pathname}?join=${gameId}`;
    return `https://quickchart.io/qr?text=${encodeURIComponent(url)}&size=300`;
  }

  /****************************************
   * START SCREEN
   ****************************************/
  function StartScreen({ onCreate, onJoin }){
    const [name,setName] = useState('');
    const [code,setCode] = useState('');
    return (
      <div className="min-h-screen flex items-center justify-center p-6" style={{background:'var(--bg)'}}>
        <div style={{maxWidth:760, width:'100%'}} className="card">
          <div style={{display:'flex', alignItems:'center', gap:12}}>
            <RTLLogo size="md" />
            <div style={{fontWeight:900, fontSize:20}}>AdAlliance Quiz</div>
          </div>

          <h1 style={{fontSize:28, fontWeight:900, marginTop:12, color:'var(--rtl-orange)'}}>Quiz Master</h1>
          <p style={{color:'var(--muted)'}}>Host erstellt Spiel oder Spieler treten per Code/QR bei</p>

          <div style={{marginTop:12}}>
            <input className="w-full p-3 mb-3" placeholder="Dein Name" value={name} onChange={e=>setName(e.target.value)} />
            <div style={{display:'flex', gap:8}}>
              <button className="btn btn-host flex-1" onClick={()=>onCreate(name)} disabled={!name}>Host werden</button>
              <input className="p-2" placeholder="Code" value={code} onChange={e=>setCode(e.target.value.toUpperCase())} style={{width:'120px'}} />
              <button className="btn btn-join" onClick={()=>onJoin(name,code)} disabled={!name || !code}>Beitreten</button>
            </div>
            <p className="text-sm mt-3" style={{color:'var(--muted)'}}>‚ÑπÔ∏è Host ist Quizmaster und wird nicht als Spieler gez√§hlt</p>
          </div>
        </div>
      </div>
    );
  }

  /****************************************
   * HOST CONTROLLER
   ****************************************/
  function HostController({ gameId, meta, startNextRound, showResultsNow, startGame, onPause }){
    const [players,setPlayers] = useState({});
    const [finaleEnabled, setFinaleEnabled] = useState(true);

    useEffect(()=>{
      const ref = db.ref(`games/${gameId}/players`);
      ref.on('value', snap => setPlayers(snap.val() || {}));
      return ()=> ref.off();
    },[gameId]);

    useEffect(()=>{
      if(meta && meta.finaleEnabled !== undefined) {
        setFinaleEnabled(meta.finaleEnabled);
      }
    },[meta]);

    const toggleFinale = async () => {
      const newValue = !finaleEnabled;
      setFinaleEnabled(newValue);
      await db.ref(`games/${gameId}/meta/finaleEnabled`).set(newValue);
    };

    if(!meta) return <div className="card">Lade...</div>;
    
    const phaseDisplay = meta.phase === 'finalQuestion' ? 'Finale' : 
                         meta.phase === 'finalReview' ? 'Finale Auswertung' : 
                         meta.phase;
    
    return (
      <div className="card" style={{display:'flex', flexDirection:'column', gap:12}}>
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', flexWrap:'wrap', gap:8}}>
          <div style={{fontSize:'16px'}}>
            <div style={{color:'var(--muted)'}}>Phase: <strong style={{color:'var(--rtl-orange)'}}>{phaseDisplay}</strong></div>
            {meta.phase !== 'finalQuestion' && meta.phase !== 'finalReview' && (
              <>
                <div style={{color:'var(--muted)'}}>Runde: <strong style={{color:'var(--rtl-orange)'}}>{meta.round || 1}/{TOTAL_ROUNDS}</strong></div>
                <div style={{color:'var(--muted)'}}>Frage: <strong style={{color:'var(--rtl-orange)'}}>{(meta.questionIndex || 0) + 1}/{TOTAL_ROUNDS * QUESTIONS_PER_ROUND}</strong></div>
              </>
            )}
            {(meta.phase === 'finalQuestion' || meta.phase === 'finalReview') && (
              <div style={{color:'var(--muted)'}}>Final-Frage: <strong style={{color:'var(--rtl-orange)'}}>{(meta.finalQuestionIndex || 0) + 1}/{FINAL_QUESTIONS}</strong></div>
            )}
          </div>
          <div style={{display:'flex', gap:8, alignItems:'center'}}>
            <div style={{textAlign:'right', color:'var(--muted)', fontSize:'16px'}}>üë• Spieler: {Object.keys(players).length}</div>
            {(meta.phase !== 'lobby' && meta.phase) && (
              <button className="btn btn-pause" onClick={onPause} style={{fontSize:'16px', padding:'10px 16px'}}>‚è∏Ô∏è PAUSE</button>
            )}
          </div>
        </div>

        <div style={{display:'flex', gap:8, flexWrap:'wrap'}}>
          {(meta.phase === 'lobby' || !meta.phase) && (
            <>
              <button className="btn btn-host" onClick={startGame}>Spiel starten</button>
              <div style={{display:'flex', alignItems:'center', gap:10, padding:'6px 12px', background:'rgba(255,255,255,0.02)', borderRadius:'8px'}}>
                <span style={{fontSize:'15px', fontWeight:700}}>Finale:</span>
                <label className="toggle-switch">
                  <input type="checkbox" checked={finaleEnabled} onChange={toggleFinale} />
                  <span className="toggle-slider"></span>
                </label>
              </div>
            </>
          )}
          {meta.phase === 'question' && <button className="btn btn-show-results" onClick={showResultsNow}>Aufl√∂sen</button>}
          {meta.phase === 'results' && <button className="btn btn-host" onClick={startNextRound}>Weiter ‚Üí</button>}
          {meta.phase === 'roundSummary' && <button className="btn btn-host" onClick={startNextRound}>N√§chste Runde ‚Üí</button>}
          {meta.phase === 'finished' && <button className="btn" onClick={()=>window.location.reload()}>üîÑ Zur√ºck zur Lobby</button>}
        </div>

        {meta && meta.categoryState && (
          <div style={{fontSize:'15px'}}>
            <h4 style={{fontWeight:900, marginBottom:8}}>üîñ Kategorien</h4>
            <div style={{display:'flex', gap:8, flexWrap:'wrap'}}>
              {(meta.categoryState.used || []).map(c=>(
                <div key={c} style={{padding:'6px 10px', background:'rgba(255,255,255,0.02)', fontSize:'14px'}}>{c} ‚úÖ</div>
              ))}
              {(meta.categoryState.remaining || []).map(c=>(
                <div key={c} style={{padding:'6px 10px', background:'rgba(255,255,255,0.01)', fontSize:'14px'}}>{c}</div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  }

  /****************************************
   * HOST SCREEN
   ****************************************/
  function HostScreen({ gameId, hostName }){
    const [game,setGame] = useState(null);
    const [meta,setMeta] = useState(null);
    const [timeLeft,setTimeLeft] = useState(0);
    const [pauseModalOpen, setPauseModalOpen] = useState(false);
    const timerRef = useRef(null);

    useEffect(()=>{
      const gRef = db.ref(`games/${gameId}`);
      gRef.on('value', snap => setGame(snap.val()));
      const mRef = db.ref(`games/${gameId}/meta`);
      mRef.on('value', snap => setMeta(snap.val()));
      return ()=> { gRef.off(); mRef.off(); clearInterval(timerRef.current); };
    },[gameId]);

    useEffect(()=>{
      if(!meta) { setTimeLeft(0); return; }
      
      if(meta.phase === 'question' && meta.questionStartTime){
        const tick = async ()=>{
          const elapsed = Math.floor((Date.now() - meta.questionStartTime)/1000);
          const rem = Math.max(0, QUESTION_TIME - elapsed);
          setTimeLeft(rem);
          if(rem === 0) {
            await showResultsNow();
          }
        };
        tick();
        clearInterval(timerRef.current);
        timerRef.current = setInterval(tick, 500);
        return ()=> clearInterval(timerRef.current);
      } else if(meta.phase === 'finalQuestion' && meta.finalQuestionStartTime){
        const tick = async ()=>{
          const elapsed = Math.floor((Date.now() - meta.finalQuestionStartTime)/1000);
          const rem = Math.max(0, FINAL_TIME - elapsed);
          setTimeLeft(rem);
          if(rem === 0) {
            await nextFinalQuestion();
          }
        };
        tick();
        clearInterval(timerRef.current);
        timerRef.current = setInterval(tick, 500);
        return ()=> clearInterval(timerRef.current);
      } else {
        setTimeLeft(0);
      }
    },[meta?.phase, meta?.questionStartTime, meta?.finalQuestionStartTime]);

    const handlePause = () => {
      setPauseModalOpen(true);
    };

    const resumeGame = () => {
      setPauseModalOpen(false);
    };

    const backToLobby = async ()=>{
      await db.ref(`games/${gameId}/meta`).set({ phase: 'lobby', finaleEnabled: meta?.finaleEnabled ?? true });
      await db.ref(`games/${gameId}/questions`).remove();
      await db.ref(`games/${gameId}/finalQuestions`).remove();
      await db.ref(`games/${gameId}/meta/categoryState`).remove();
      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const updates = {};
      Object.keys(pObj).forEach(pid=>{
        updates[`games/${gameId}/players/${pid}/score`] = 0;
        updates[`games/${gameId}/players/${pid}/currentAnswer`] = null;
        updates[`games/${gameId}/players/${pid}/items`] = DEFAULT_ITEMS;
        updates[`games/${gameId}/players/${pid}/activeEffects`] = { boost:false, boostTarget:null, shield:false, shieldTarget:null, poisonedBy: [] };
        updates[`games/${gameId}/players/${pid}/lastPoints`] = 0;
        updates[`games/${gameId}/players/${pid}/lastRoundBonus`] = null;
        updates[`games/${gameId}/players/${pid}/hasTraded`] = false;
        updates[`games/${gameId}/players/${pid}/isFinalist`] = false;
        updates[`games/${gameId}/players/${pid}/finalAnswers`] = null;
      });
      await db.ref().update(updates);
      setPauseModalOpen(false);
    };

    const showResultsNow = async ()=>{
      try{
        const snap = await db.ref(`games/${gameId}`).get();
        const g = snap.val();
        if(!g) return;
        const qIndex = g.meta?.questionIndex || 0;
        const q = (g.questions || [])[qIndex];
        if(!q) return;

        const playerObj = g.players || {};
        const updates = {};
        const actionLogRef = db.ref(`games/${gameId}/meta/actions/${qIndex}`);
        const actionsSnap = await actionLogRef.get();
        const actions = actionsSnap.exists() ? actionsSnap.val() : [];

        const categoryChooser = g.meta?.categoryChooserForRound || null;

        Object.entries(playerObj).forEach(([pid,p])=>{
          const ans = p.currentAnswer;
          const correct = typeof ans === 'number' && ans === q.correct;
          let points = correct ? BASE_POINTS : 0;

          const boostActive = p.activeEffects && p.activeEffects.boost;
          if(correct && boostActive){
            points = Math.round(points * 1.5);
          }

          if(correct && categoryChooser === pid){
            points = Math.round(points * CATEGORY_CHOOSER_BONUS);
          }

          const poisonArr = (p.activeEffects && p.activeEffects.poisonedBy) ? p.activeEffects.poisonedBy : [];
          const poisonCount = Array.isArray(poisonArr) ? poisonArr.length : 0;
          points -= (poisonCount * 20);
          if(points < 0) points = 0;

          const newScore = (p.score || 0) + points;
          updates[`games/${gameId}/players/${pid}/score`] = newScore;
          updates[`games/${gameId}/players/${pid}/lastPoints`] = points;
        });

        await db.ref().update(updates);
        await db.ref(`games/${gameId}/meta`).update({ phase: 'results' });
      }catch(e){ console.error(e); }
    };

    const startNextRound = async ()=>{
      if(!meta) return;

      if(meta.phase === 'results'){
        const currentIndex = meta.questionIndex ?? 0;
        const nextIndex = currentIndex + 1;
        const totalQuestions = TOTAL_ROUNDS * QUESTIONS_PER_ROUND;
        
        const questionInRound = (currentIndex + 1) % QUESTIONS_PER_ROUND;
        const finishedRound = Math.floor((currentIndex + 1) / QUESTIONS_PER_ROUND);
        
        if (questionInRound === 0) {
          if (finishedRound >= TOTAL_ROUNDS) {
            // Pr√ºfe ob Finale aktiviert ist
            if(meta.finaleEnabled === false) {
              await db.ref(`games/${gameId}/meta`).update({ phase: 'finished' });
              return;
            }
            await prepareFinale();
            return;
          } else {
            await db.ref(`games/${gameId}/meta`).update({
              phase: 'roundSummary',
              round: finishedRound + 1
            });
            return;
          }
        }
        
        if(nextIndex >= totalQuestions){
          if(meta.finaleEnabled === false) {
            await db.ref(`games/${gameId}/meta`).update({ phase: 'finished' });
            return;
          }
          await prepareFinale();
          return;
        }
        
        const pSnap = await db.ref(`games/${gameId}/players`).get();
        const pObj = pSnap.val() || {};
        const updates = {};
        Object.keys(pObj).forEach(pid => {
          updates[`games/${gameId}/players/${pid}/currentAnswer`] = null;
          updates[`games/${gameId}/players/${pid}/activeEffects`] = { boost:false, boostTarget:null, shield:false, shieldTarget:null, poisonedBy: [] };
          updates[`games/${gameId}/players/${pid}/hasTraded`] = false;
        });
        await db.ref().update(updates);

        const currentRound = Math.floor(nextIndex / QUESTIONS_PER_ROUND) + 1;
        await db.ref(`games/${gameId}/meta`).update({
          questionIndex: nextIndex,
          phase: 'question',
          questionStartTime: Date.now(),
          round: currentRound
        });
        return;
      }

      if(meta.phase === 'roundSummary'){
        const currentIndex = meta.questionIndex ?? 0;
        const nextIndex = currentIndex + 1;
        const totalQuestions = TOTAL_ROUNDS * QUESTIONS_PER_ROUND;
        if(nextIndex >= totalQuestions){
          if(meta.finaleEnabled === false) {
            await db.ref(`games/${gameId}/meta`).update({ phase: 'finished' });
            return;
          }
          await prepareFinale();
          return;
        }

        const metaSnap = await db.ref(`games/${gameId}/meta`).get();
        const metaVal = metaSnap.exists() ? metaSnap.val() : {};
        const catState = metaVal.categoryState || { used: [], remaining: [] };

        let chosenCategory = metaVal.nextCategory || null;
        if(!chosenCategory){
          const fallbackCat = (catState.remaining && catState.remaining.length>0) ? catState.remaining[0] : (catState.used && catState.used.length>0 ? catState.used[0] : null);
          chosenCategory = fallbackCat;
        }

        const remaining = (catState.remaining || []).filter(c => c !== chosenCategory);
        const used = [...(catState.used || []), chosenCategory];
        await db.ref(`games/${gameId}/meta/categoryState`).set({ used, remaining });

        const nextRound = Math.floor(nextIndex / QUESTIONS_PER_ROUND) + 1;
        const start = (nextRound - 1) * QUESTIONS_PER_ROUND;
        const qSnap = await db.ref(`games/${gameId}/questions`).get();
        const qArr = qSnap.exists() ? (qSnap.val() || []) : [];
        const usedQTexts = (qArr || []).map(q => q.question);
        const newBlock = getQuestionsForCategory(chosenCategory, QUESTIONS_PER_ROUND, usedQTexts);

        const newQuestions = Array.isArray(qArr) ? qArr.slice() : [];
        for(let i=0;i<newBlock.length;i++){
          newQuestions[start + i] = newBlock[i];
        }
        await db.ref(`games/${gameId}/questions`).set(newQuestions);

        const pSnap = await db.ref(`games/${gameId}/players`).get();
        const pObj = pSnap.val() || {};
        const updates = {};
        Object.keys(pObj).forEach(pid => {
          updates[`games/${gameId}/players/${pid}/currentAnswer`] = null;
          updates[`games/${gameId}/players/${pid}/activeEffects`] = { boost:false, boostTarget:null, shield:false, shieldTarget:null, poisonedBy: [] };
          updates[`games/${gameId}/players/${pid}/hasTraded`] = false;
        });
        await db.ref().update(updates);

        const categoryChooser = metaVal.categoryChooserForRound || null;

        await db.ref(`games/${gameId}/meta`).update({
          questionIndex: nextIndex,
          phase: 'question',
          questionStartTime: Date.now(),
          round: nextRound,
          currentCategory: chosenCategory,
          nextCategory: null,
          categoryChooserForRound: categoryChooser
        });
        return;
      }
    };

    const prepareFinale = async () => {
      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const playersArr = Object.entries(pObj).map(([pid,p])=>({pid,...p})).sort((a,b)=>(b.score||0)-(a.score||0));
      
      if(playersArr.length < 2){
        await db.ref(`games/${gameId}/meta`).update({ phase: 'finished' });
        return;
      }

      const top2 = playersArr.slice(0, 2).map(p => p.pid);
      
      const finalQuestions = shuffle(FINAL_QUESTION_POOL).slice(0, FINAL_QUESTIONS);
      await db.ref(`games/${gameId}/finalQuestions`).set(finalQuestions);
      
      const updates = {};
      Object.keys(pObj).forEach(pid => {
        updates[`games/${gameId}/players/${pid}/isFinalist`] = top2.includes(pid);
        updates[`games/${gameId}/players/${pid}/finalAnswers`] = {};
        updates[`games/${gameId}/players/${pid}/finalistReady`] = false;
      });
      await db.ref().update(updates);

      await db.ref(`games/${gameId}/meta`).update({
        phase: 'finalIntro',
        finalists: top2
      });
    };

    const startFinalQuestion = async () => {
      await db.ref(`games/${gameId}/meta`).update({
        phase: 'finalQuestion',
        finalQuestionIndex: 0,
        finalQuestionStartTime: Date.now()
      });
    };

    const nextFinalQuestion = async () => {
      const snap = await db.ref(`games/${gameId}`).get();
      const g = snap.val();
      if(!g) return;

      const currentIndex = (g.meta?.finalQuestionIndex || 0) + 1;
      
      if(currentIndex >= FINAL_QUESTIONS){
        await db.ref(`games/${gameId}/meta`).update({ 
          phase: 'finalReview',
          finalReviewIndex: 0
        });
      } else {
        await db.ref(`games/${gameId}/meta`).update({
          finalQuestionIndex: currentIndex,
          finalQuestionStartTime: Date.now()
        });
      }
    };

    const startFinalReview = async () => {
      await db.ref(`games/${gameId}/meta`).update({
        phase: 'finalReview',
        finalReviewIndex: 0
      });
    };

    const judgeFinalAnswer = async (playerId, correct) => {
      const snap = await db.ref(`games/${gameId}`).get();
      const g = snap.val();
      if(!g) return;

      const reviewIndex = g.meta?.finalReviewIndex || 0;
      const player = g.players?.[playerId];
      if(!player) return;

      const points = correct ? FINAL_POINTS : 0;
      const newScore = (player.score || 0) + points;

      await db.ref(`games/${gameId}/players/${playerId}`).update({
        score: newScore,
        [`finalScores/${reviewIndex}`]: points
      });
    };

    const nextFinalReview = async () => {
      const snap = await db.ref(`games/${gameId}`).get();
      const g = snap.val();
      if(!g) return;

      const reviewIndex = (g.meta?.finalReviewIndex || 0) + 1;
      
      if(reviewIndex >= FINAL_QUESTIONS){
        await db.ref(`games/${gameId}/meta`).update({ phase: 'finished' });
      } else {
        await db.ref(`games/${gameId}/meta`).update({ finalReviewIndex: reviewIndex });
      }
    };

    const startGame = async ()=>{
      const categoriesForGame = shuffle(CATEGORY_LIST).slice(0, TOTAL_ROUNDS);
      let allQuestions = [];
      const usedQuestions = [];
      for(let r=0;r<categoriesForGame.length;r++){
        const cat = categoriesForGame[r];
        const block = getQuestionsForCategory(cat, QUESTIONS_PER_ROUND, usedQuestions);
        block.forEach(q => usedQuestions.push(q.question));
        allQuestions = allQuestions.concat(block);
      }

      await db.ref(`games/${gameId}/questions`).set(allQuestions);
      await db.ref(`games/${gameId}/meta/categoryState`).set({ used: [], remaining: categoriesForGame });

      const finaleEnabled = meta?.finaleEnabled ?? true;
      const metaObj = { 
        phase: 'question', 
        questionIndex: 0, 
        round: 1, 
        questionStartTime: Date.now(), 
        currentCategory: categoriesForGame[0], 
        categoryChooserForRound: null,
        finaleEnabled: finaleEnabled
      };
      await db.ref(`games/${gameId}/meta`).set(metaObj);

      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const updates = {};
      Object.keys(pObj).forEach(pid=>{
        updates[`games/${gameId}/players/${pid}/score`] = 0;
        updates[`games/${gameId}/players/${pid}/currentAnswer`] = null;
        if(!(pObj[pid] && pObj[pid].items)){
          updates[`games/${gameId}/players/${pid}/items`] = DEFAULT_ITEMS;
        }
        updates[`games/${gameId}/players/${pid}/activeEffects`] = { boost:false, boostTarget:null, shield:false, shieldTarget:null, poisonedBy: [] };
        updates[`games/${gameId}/players/${pid}/lastPoints`] = 0;
        updates[`games/${gameId}/players/${pid}/lastRoundBonus`] = null;
        updates[`games/${gameId}/players/${pid}/hasTraded`] = false;
      });
      await db.ref().update(updates);
      await db.ref(`games/${gameId}/meta/actions`).remove();
    };

    if(!meta || !game) return <div className="min-h-screen flex items-center justify-center">Lade Spiel...</div>;

    const qIndex = meta.questionIndex || 0;
    const question = (game.questions || [])[qIndex];
    const playersArr = Object.entries(game.players || {}).map(([pid,p])=>({pid,...p})).sort((a,b)=>(b.score||0)-(a.score||0));
    const countdownClass = timeLeft <= 10 ? 'danger' : timeLeft <= 20 ? 'warning' : '';
    const showSidebar = meta.phase === 'lobby';

    return (
      <div className="min-h-screen host-screen">
        <div className={`host-main ${!showSidebar ? 'fullwidth' : ''}`}>
          {meta.phase === 'lobby' && (
            <div style={{display:'flex', flexDirection:'column', alignItems:'center', gap:10}}>
              <div style={{display:'flex', alignItems:'center', gap:12}}>
                <RTLLogo size="lg" />
                <div style={{fontWeight:900, fontSize:22}}>AdAlliance Quiz</div>
              </div>
              <h2 style={{fontSize:32, fontWeight:900, margin:'8px 0'}}>‚è≥ Warte auf Spieler</h2>
              <p style={{color:'var(--muted)', margin:0}}>Spielcode:</p>
              <div style={{fontFamily:'monospace', background:'#fff', color:'#000', padding:'6px 12px', fontSize:22, fontWeight:900}}>{gameId}</div>

              {playersArr.length > 0 && (
                <div style={{marginTop:16, width:'100%', maxWidth:600}}>
                  <h3 style={{fontSize:16, fontWeight:800, marginBottom:10, color:'var(--rtl-orange)'}}>Angemeldete Spieler ({playersArr.length})</h3>
                  <div className="scrollable-section" style={{display:'grid', gap:6}}>
                    {playersArr.map((p,i)=>(p && (
                      <div key={p.pid} style={{display:'flex', justifyContent:'space-between', padding:10, background:'rgba(255,255,255,0.02)', borderLeft:'3px solid var(--rtl-purple)', fontSize:'14px'}}>
                        <div style={{fontWeight:700}}>{p.name}</div>
                        <div style={{color:'var(--muted)'}}>Bereit ‚úì</div>
                      </div>
                    )))}
                  </div>
                </div>
              )}
            </div>
          )}

          {meta.phase === 'question' && question && (
            <div style={{display:'flex', flexDirection:'column', gap:10, minHeight:0}}>
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', flexWrap:'wrap', gap:10}}>
                <div style={{display:'flex', alignItems:'center', gap:10}}>
                  <div className={`countdown-badge ${countdownClass}`}>{timeLeft}</div>
                  <div style={{fontSize:'16px'}}>
                    <div style={{color:'var(--muted)'}}>Runde {meta.round}/{TOTAL_ROUNDS}</div>
                    <div style={{color:'var(--muted)'}}>Frage {qIndex + 1}/{TOTAL_ROUNDS * QUESTIONS_PER_ROUND}</div>
                    <div style={{color:'var(--muted)'}}>Kategorie: <strong style={{color:'var(--rtl-orange)'}}>{meta.currentCategory || question.category || '‚Äî'}</strong></div>
                  </div>
                </div>
                <button className="btn btn-show-results" onClick={showResultsNow}>L√∂sung anzeigen</button>
              </div>

              <div>
                <div style={{fontSize:32, fontWeight:900, marginBottom:8}}>{question.question}</div>
                <div className="answers-grid">
                  {question.answers.map((a,i)=>(
                    <div key={i} className="answer-btn">
                      <div style={{fontWeight:900, marginRight:8, fontSize:28}}>{String.fromCharCode(65+i)}.</div>
                      <div>{a}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {meta.phase === 'results' && question && (
            <div style={{maxHeight:'100%', overflow:'auto'}}>
              <h2 style={{fontSize:22, fontWeight:900, color:'var(--rtl-orange)', margin:'0 0 8px 0'}}>Ergebnis</h2>
              <div style={{padding:10, background:'rgba(255,255,255,0.03)', fontSize:'14px', marginBottom:12}}>
                ‚úì Richtige Antwort: <strong>{question.answers[question.correct]}</strong>
              </div>

              <div style={{display:'grid', gridTemplateColumns:'repeat(2,1fr)', gap:10, marginBottom:12}}>
                {question.answers.map((a,i)=>{
                  const voters = playersArr.filter(p => p.currentAnswer === i);
                  const isCorrect = i === question.correct;
                  return (
                    <div key={i} style={{padding:10, border:isCorrect ? '2px solid rgba(255,255,255,0.3)' : '2px solid rgba(0,0,0,0.06)', background:isCorrect ? '#fff' : 'rgba(255,255,255,0.02)', color:isCorrect ? '#000' : 'var(--tile)', fontSize:'13px'}}>
                      <div style={{fontWeight:900, marginBottom:4}}>{String.fromCharCode(65+i)}. {a}</div>
                      <div style={{opacity:0.7, fontSize:'12px'}}>{voters.length > 0 ? voters.map(p => p.name).join(', ') : '(Niemand)'}</div>
                    </div>
                  );
                })}
              </div>

              <div style={{marginBottom:12}}>
                <h3 style={{fontWeight:900, color:'var(--rtl-orange)', fontSize:'16px', marginBottom:6}}>Aktionen & Effekte Log</h3>
                <div className="scrollable-section">
                  {(() => {
                    const actionLogRef = game.meta?.actions?.[qIndex] || [];
                    const actions = Array.isArray(actionLogRef) ? actionLogRef : [];
                    
                    if(actions.length === 0) {
                      return <div style={{color:'var(--muted)', padding:8, fontSize:'13px'}}>Keine Aktionen in dieser Runde</div>;
                    }

                    return actions.map((action, idx) => {
                      const fromPlayer = playersArr.find(p => p.pid === action.from);
                      const toPlayer = playersArr.find(p => p.pid === action.to);
                      const fromName = fromPlayer ? fromPlayer.name : 'Unbekannt';
                      const toName = toPlayer ? toPlayer.name : 'Unbekannt';

                      if(action.type === 'boost') {
                        return (
                          <div key={idx} className="action-log-item boost">
                            <strong>üî• Boost:</strong> {fromName} hat {action.target === action.from ? 'sich selbst' : toName} geboostet
                          </div>
                        );
                      }
                      if(action.type === 'poison') {
                        return (
                          <div key={idx} className="action-log-item poison">
                            <strong>‚ò†Ô∏è Gift:</strong> {fromName} ‚Üí {toName} {action.blocked ? '(‚ùå blockiert)' : '(‚úì erfolgreich)'}
                          </div>
                        );
                      }
                      if(action.type === 'shield') {
                        return (
                          <div key={idx} className="action-log-item shield">
                            <strong>üõ° Schild:</strong> {fromName} hat {action.target === action.from ? 'sich selbst' : toName} gesch√ºtzt
                          </div>
                        );
                      }
                      if(action.type === 'trade') {
                        const itemEmoji = action.item === 'boost' ? 'üî•' : action.item === 'poison' ? '‚ò†Ô∏è' : 'üõ°';
                        return (
                          <div key={idx} className="action-log-item trade">
                            <strong>ü§ù Handel:</strong> {fromName} hat {itemEmoji} an {toName} gegeben
                          </div>
                        );
                      }
                      return null;
                    });
                  })()}
                </div>
              </div>

              <div>
                <h3 style={{fontWeight:900, color:'var(--rtl-orange)', fontSize:'16px', marginBottom:6}}>Spieler Punktestand</h3>
                <div className="scrollable-section compact-grid">
                  {playersArr.map((p)=>(
                    <div key={p.pid} style={{display:'flex', justifyContent:'space-between', padding:8, background:'rgba(255,255,255,0.01)', fontSize:'13px'}}>
                      <div style={{display:'flex', gap:8, alignItems:'center'}}>
                        <div style={{fontWeight:900}}>{p.name}</div>
                        {meta.categoryChooserForRound === p.pid && (
                          <div style={{fontSize:10, background:'var(--rtl-orange)', color:'white', padding:'2px 6px', fontWeight:900}}>+20%</div>
                        )}
                      </div>
                      <div style={{display:'flex', gap:8, alignItems:'center', fontSize:'12px'}}>
                        <div>üî•{(p.items && p.items.boost) ? p.items.boost : 0}</div>
                        <div>‚ò†Ô∏è{(p.items && p.items.poison) ? p.items.poison : 0}</div>
                        <div>üõ°{(p.items && p.items.shield) ? p.items.shield : 0}</div>
                        <div style={{fontWeight:900, minWidth:60, textAlign:'right'}}>{p.lastPoints || 0} pts</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div style={{marginTop:12}}>
                <button className="btn btn-host" onClick={startNextRound}>N√§chste Frage ‚Üí</button>
              </div>
            </div>
          )}

          {meta.phase === 'roundSummary' && (
            <div>
              <h2 style={{fontSize:20, fontWeight:900, color:'var(--rtl-orange)', margin:'0 0 8px 0'}}>üèÜ Zwischenstand nach Runde {meta.round - 1}</h2>
              <p style={{color:'var(--muted)', fontSize:'14px', marginBottom:10}}>Aktueller Stand aller Spieler</p>

              <div className="scrollable-section compact-grid">
                {playersArr.map((p,i)=>{ 
                  const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':''; 
                  return (
                    <div key={p.pid} style={{display:'flex', justifyContent:'space-between', padding:10, background:i<3?'rgba(255,255,255,0.03)':'rgba(255,255,255,0.01)', fontSize:'14px'}}>
                      <div style={{display:'flex', gap:8, alignItems:'center'}}>
                        <div style={{fontSize:16}}>{medal || `#${i+1}`}</div>
                        <div style={{fontWeight:900}}>{p.name}</div>
                      </div>
                      <div style={{display:'flex', gap:10, alignItems:'center', fontSize:'13px'}}>
                        <div>üî•{(p.items && p.items.boost) ? p.items.boost : 0}</div>
                        <div>‚ò†Ô∏è{(p.items && p.items.poison) ? p.items.poison : 0}</div>
                        <div>üõ°{(p.items && p.items.shield) ? p.items.shield : 0}</div>
                        <div style={{fontWeight:900}}>{p.score || 0} pts</div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <div style={{marginTop:14, textAlign:'center'}}>
                <button className="btn btn-host" style={{padding:'10px 18px'}} onClick={startNextRound}>
                  {meta.round > TOTAL_ROUNDS ? (meta.finaleEnabled !== false ? 'Zum Finale ‚Üí' : 'Spiel beenden') : 'Weiter zur n√§chsten Runde ‚Üí'}
                </button>
              </div>
            </div>
          )}

          {meta.phase === 'finalIntro' && (
            <FinalIntroHostView 
              game={game} 
              meta={meta}
              onStart={startFinalQuestion}
            />
          )}

          {meta.phase === 'finalQuestion' && (
            <FinalQuestionHostView 
              game={game} 
              meta={meta} 
              timeLeft={timeLeft}
              onNext={nextFinalQuestion}
            />
          )}

          {meta.phase === 'finalReview' && (
            <FinalReviewHostView 
              game={game} 
              meta={meta}
              onJudge={judgeFinalAnswer}
              onNext={nextFinalReview}
            />
          )}

          {meta.phase === 'finished' && (
            <div style={{textAlign:'center', padding:'16px', maxHeight:'100%', overflow:'auto'}}>
              <h2 style={{fontSize:30, fontWeight:900, marginBottom:8}}>üéâ Spiel beendet!</h2>
              <p style={{color:'var(--muted)', fontSize:16, marginBottom:16}}>Finale Platzierungen</p>

              {playersArr[0] && (
                <div style={{
                  marginTop:16,
                  padding:'16px',
                  background:'rgba(255,255,255,0.04)',
                  border:'1px solid rgba(255,255,255,0.1)',
                  marginBottom:16
                }}>
                  <div style={{fontSize:40}}>ü•á</div>
                  <div style={{fontSize:24, fontWeight:900, marginTop:4}}>{playersArr[0].name}</div>
                  <div style={{fontSize:20, color:'var(--rtl-green)', fontWeight:800}}>
                    {playersArr[0].score} Punkte
                  </div>
                </div>
              )}

              <div style={{
                maxWidth:600,
                marginInline:'auto',
                textAlign:'left',
                maxHeight:'40vh',
                overflow:'auto'
              }}>
                {playersArr.map((p,i)=>(
                  <div key={p.pid} style={{
                    display:'flex',
                    alignItems:'center',
                    justifyContent:'space-between',
                    padding:'8px 12px',
                    background:i < 3 ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.02)',
                    borderLeft: i===0 ? '4px solid gold' :
                               i===1 ? '4px solid silver' :
                               i===2 ? '4px solid #cd7f32' : 
                                       '4px solid rgba(255,255,255,0.05)',
                    marginBottom:4,
                    fontSize:'14px'
                  }}>
                    <div style={{display:'flex', alignItems:'center', gap:8}}>
                      <div style={{
                        width:30,
                        height:30,
                        background:'rgba(255,255,255,0.1)',
                        display:'flex',
                        justifyContent:'center',
                        alignItems:'center',
                        fontWeight:900,
                        fontSize:14
                      }}>
                        {p.name.charAt(0).toUpperCase()}
                      </div>
                      <div style={{fontWeight:900}}>
                        {i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`#${i+1}`} {p.name}
                      </div>
                    </div>
                    <div style={{fontSize:16, fontWeight:900, color:'var(--rtl-green)'}}>
                      {p.score}
                    </div>
                  </div>
                ))}
              </div>

              <div style={{marginTop:16}}>
                <button className="btn btn-host" style={{padding:'10px 16px', fontSize:16}} onClick={backToLobby}>
                  üîÑ Zur√ºck zur Lobby
                </button>
              </div>
            </div>
          )}
        </div>

        {showSidebar && (
          <div className="host-side">
            <HostController 
              gameId={gameId} 
              meta={meta} 
              startNextRound={startNextRound} 
              showResultsNow={showResultsNow} 
              startGame={startGame}
              onPause={handlePause}
            />

            <div style={{marginTop:14}}>
              <h3 style={{fontWeight:900, color:'var(--rtl-orange)', fontSize:'16px', marginBottom:8}}>üèÖ Spieler & Punkte</h3>
              <div className="scrollable-section">
                {playersArr.map((p,idx)=>(
                  <div key={p.pid} style={{display:'flex', justifyContent:'space-between', padding:10, fontSize:'15px'}}>
                    <div style={{display:'flex', gap:8, alignItems:'center'}}>
                      <div style={{fontWeight:900, color:'var(--rtl-purple)'}}>#{idx+1}</div>
                      <div style={{fontWeight:700}}>{p.name}</div>
                    </div>
                    <div style={{display:'flex', gap:10, alignItems:'center'}}>
                      <div style={{fontWeight:900, color:'var(--rtl-green)'}}>{p.score || 0}</div>
                      <div style={{fontSize:13, color:'var(--muted)'}}>üî•{(p.items && p.items.boost) ? p.items.boost : 0} ‚ò†Ô∏è{(p.items && p.items.poison) ? p.items.poison : 0} üõ°{(p.items && p.items.shield) ? p.items.shield : 0}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div style={{marginTop:16}}>
              <h3 style={{fontWeight:900, fontSize:'16px', marginBottom:8}}>‚ÑπÔ∏è Code & QR</h3>
              <div style={{marginTop:8}}>
                <div style={{marginBottom:8, fontSize:'15px'}}><span style={{fontFamily:'monospace', background:'#fff', color:'#000', padding:'4px 8px'}}>{gameId}</span></div>
                <img src={qrUrlForGame(gameId)} alt="QR Code" style={{width:'100%'}} />
              </div>
            </div>
          </div>
        )}

        {pauseModalOpen && (
          <div className="modal-backdrop">
            <div className="modal-card">
              <h3 style={{fontWeight:900, fontSize:20, marginBottom:12, textAlign:'center'}}>‚è∏Ô∏è Spiel pausiert</h3>
              <p style={{color:'var(--muted)', textAlign:'center', marginBottom:20}}>
                Was m√∂chtest du tun?
              </p>
              <div style={{display:'flex', flexDirection:'column', gap:10}}>
                <button className="btn btn-host" onClick={resumeGame} style={{width:'100%', padding:'12px', fontSize:16}}>
                  ‚ñ∂Ô∏è Fortsetzen
                </button>
                <button className="btn" onClick={backToLobby} style={{width:'100%', padding:'12px', fontSize:16, background:'rgba(255,255,255,0.1)'}}>
                  üè† Zur√ºck zur Lobby
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  /****************************************
   * FINAL INTRO HOST VIEW
   ****************************************/
  function FinalIntroHostView({ game, meta, onStart }){
    const finalists = (meta.finalists || []).map(pid => ({
      pid,
      ...(game.players?.[pid] || {})
    }));

    const allReady = finalists.every(f => f.finalistReady === true);

    return (
      <div style={{display:'flex', flexDirection:'column', gap:14, height:'100%', justifyContent:'center'}}>
        <div style={{textAlign:'center'}}>
          <h2 style={{fontSize:38, fontWeight:900, color:'var(--rtl-orange)', marginBottom:12}}>üèÜ FINALE</h2>
          <p style={{fontSize:18, color:'var(--muted)', marginBottom:20}}>
            Die Top 2 Spieler haben sich qualifiziert!
          </p>
        </div>

        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:16, maxWidth:800, margin:'0 auto', width:'100%'}}>
          {finalists.map((f, idx) => (
            <div key={f.pid} style={{
              padding:18, 
              background:'rgba(255,255,255,0.03)', 
              border:'2px solid var(--rtl-orange)',
              textAlign:'center'
            }}>
              <div style={{fontSize:40, marginBottom:8}}>{idx === 0 ? 'ü•á' : 'ü•à'}</div>
              <div style={{fontSize:22, fontWeight:900, marginBottom:6}}>{f.name}</div>
              <div style={{fontSize:18, color:'var(--rtl-green)', fontWeight:700}}>{f.score || 0} Punkte</div>
              <div style={{marginTop:12, padding:10, background: f.finalistReady ? 'rgba(34,197,94,0.2)' : 'rgba(255,255,255,0.05)', fontSize:'14px'}}>
                {f.finalistReady ? '‚úì Bereit' : '‚è≥ Wartet...'}
              </div>
            </div>
          ))}
        </div>

        <div style={{maxWidth:700, margin:'24px auto 0', padding:18, background:'rgba(255,102,0,0.1)', border:'2px solid var(--rtl-orange)'}}>
          <h3 style={{fontSize:20, fontWeight:900, marginBottom:12, textAlign:'center'}}>‚ö° Finale-Regeln</h3>
          <ul style={{fontSize:15, lineHeight:1.6, listStylePosition:'inside', margin:0, padding:0}}>
            <li><strong>5 offene Fragen</strong> nacheinander</li>
            <li><strong>60 Sekunden Zeit</strong> pro Frage</li>
            <li><strong>Jede richtige Antwort = {FINAL_POINTS} Punkte</strong> (doppelt!)</li>
            <li><strong>Keine Items</strong> verf√ºgbar</li>
            <li>Der Host bewertet die Antworten manuell</li>
          </ul>
        </div>

        <div style={{textAlign:'center', marginTop:24}}>
          {allReady ? (
            <button 
              className="btn btn-host" 
              onClick={onStart}
              style={{padding:'14px 28px', fontSize:18}}
            >
              üöÄ Finale starten
            </button>
          ) : (
            <div style={{color:'var(--muted)', fontSize:16}}>
              ‚è≥ Warte darauf, dass beide Finalisten bereit sind...
            </div>
          )}
        </div>
      </div>
    );
  }

  /****************************************
   * FINAL QUESTION HOST VIEW
   ****************************************/
  function FinalQuestionHostView({ game, meta, timeLeft, onNext }){
    const finalQIndex = meta.finalQuestionIndex || 0;
    const finalQuestion = (game.finalQuestions || [])[finalQIndex];
    const finalists = (meta.finalists || []).map(pid => ({
      pid,
      ...(game.players?.[pid] || {})
    }));

    const allAnswered = finalists.every(f => {
      const answers = f.finalAnswers || {};
      return answers[finalQIndex] !== undefined && answers[finalQIndex] !== null && answers[finalQIndex] !== '';
    });

    return (
      <div style={{display:'flex', flexDirection:'column', gap:14}}>
        <div style={{display:'flex', alignItems:'center', gap:10}}>
          <div className={`countdown-badge ${timeLeft <= 10 ? 'danger' : timeLeft <= 20 ? 'warning' : ''}`}>
            {timeLeft}
          </div>
          <div>
            <h2 style={{fontSize:28, fontWeight:900, color:'var(--rtl-orange)', margin:0}}>üèÜ Finale</h2>
            <div style={{fontSize:18, color:'var(--muted)'}}>Frage {finalQIndex + 1} von {FINAL_QUESTIONS}</div>
          </div>
        </div>

        <div style={{padding:16, background:'rgba(255,255,255,0.02)'}}>
          <h3 style={{fontSize:24, fontWeight:900, marginBottom:8}}>{finalQuestion?.question || 'Lade...'}</h3>
          <p style={{marginTop:10, color:'var(--muted)', fontSize:15}}>Die Finalisten tippen ihre Antwort ein (60 Sekunden Zeit)</p>
        </div>

        <div>
          <h4 style={{fontWeight:900, marginBottom:8, fontSize:'16px'}}>Finalisten:</h4>
          {finalists.map(f => {
            const hasAnswered = f.finalAnswers && f.finalAnswers[finalQIndex];
            return (
              <div key={f.pid} style={{display:'flex', justifyContent:'space-between', padding:10, background:'rgba(255,255,255,0.01)', marginBottom:6, fontSize:'14px'}}>
                <div style={{fontWeight:900}}>{f.name}</div>
                <div style={{color: hasAnswered ? 'var(--rtl-green)' : 'var(--muted)'}}>
                  {hasAnswered ? '‚úì Abgegeben' : '‚è≥ Wartet...'}
                </div>
              </div>
            );
          })}
        </div>

        {(timeLeft === 0 || allAnswered) && (
          <div style={{marginTop:16}}>
            <button className="btn btn-host" onClick={onNext}>
              {finalQIndex + 1 >= FINAL_QUESTIONS ? 'Zur Auswertung ‚Üí' : 'N√§chste Final-Frage ‚Üí'}
            </button>
          </div>
        )}
      </div>
    );
  }

  /****************************************
   * FINAL REVIEW HOST VIEW
   ****************************************/
  function FinalReviewHostView({ game, meta, onJudge, onNext }){
    const reviewIndex = meta.finalReviewIndex || 0;
    const finalQuestion = (game.finalQuestions || [])[reviewIndex];
    const finalists = (meta.finalists || []).map(pid => ({
      pid,
      ...(game.players?.[pid] || {})
    }));

    const [judgedPlayers, setJudgedPlayers] = useState({});

    const handleJudge = async (playerId, correct) => {
      await onJudge(playerId, correct);
      setJudgedPlayers(prev => ({...prev, [playerId]: correct}));
    };

    const allJudged = finalists.every(f => judgedPlayers[f.pid] !== undefined);

    return (
      <div style={{display:'flex', flexDirection:'column', gap:14, maxHeight:'100%', overflow:'auto'}}>
        <div>
          <h2 style={{fontSize:28, fontWeight:900, color:'var(--rtl-orange)', margin:'0 0 4px 0'}}>üèÜ Finale - Auswertung</h2>
          <div style={{fontSize:16, color:'var(--muted)'}}>Frage {reviewIndex + 1} von {FINAL_QUESTIONS}</div>
        </div>

        <div style={{padding:16, background:'rgba(255,255,255,0.03)'}}>
          <h3 style={{fontSize:20, fontWeight:900, marginBottom:10}}>Frage:</h3>
          <div style={{fontSize:18, marginBottom:12}}>{finalQuestion?.question}</div>
          <div style={{padding:10, background:'rgba(255,255,255,0.08)', borderLeft:'3px solid rgba(255,255,255,0.3)', fontSize:'15px'}}>
            <strong>Richtige Antwort:</strong> {finalQuestion?.answer}
          </div>
        </div>

        <div>
          <h4 style={{fontWeight:900, fontSize:18, marginBottom:10}}>Antworten der Finalisten:</h4>
          {finalists.map(f => {
            const answer = f.finalAnswers?.[reviewIndex] || '(Keine Antwort)';
            const judged = judgedPlayers[f.pid];
            
            return (
              <div key={f.pid} style={{
                padding:14, 
                background:'rgba(255,255,255,0.02)', 
                marginBottom:10,
                border: judged !== undefined ? (judged ? '2px solid rgba(255,255,255,0.4)' : '2px solid rgba(255,255,255,0.1)') : '1px solid rgba(255,255,255,0.05)'
              }}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10, fontSize:'15px'}}>
                  <div style={{fontWeight:900}}>{f.name}</div>
                  <div style={{color:'var(--muted)'}}>Aktuell: {f.score || 0} Punkte</div>
                </div>
                
                <div style={{padding:10, background:'rgba(255,255,255,0.05)', marginBottom:10, fontSize:'14px'}}>
                  <div style={{fontWeight:700}}>Antwort: {answer}</div>
                </div>

                {judged === undefined ? (
                  <div style={{display:'flex', gap:8}}>
                    <button 
                      className="btn" 
                      onClick={() => handleJudge(f.pid, true)}
                      style={{flex:1, background:'rgba(255,255,255,0.9)', color:'#000', padding:'10px', fontWeight:900}}
                    >
                      ‚úì Richtig (+{FINAL_POINTS})
                    </button>
                    <button 
                      className="btn" 
                      onClick={() => handleJudge(f.pid, false)}
                      style={{flex:1, background:'rgba(255,255,255,0.15)', color:'white', padding:'10px', fontWeight:900}}
                    >
                      ‚úó Falsch (0)
                    </button>
                  </div>
                ) : (
                  <div style={{
                    padding:8, 
                    background: judged ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.03)',
                    textAlign:'center',
                    fontWeight:900,
                    fontSize:'14px'
                  }}>
                    {judged ? `‚úì Richtig bewertet (+${FINAL_POINTS})` : '‚úó Falsch bewertet (0)'}
                  </div>
                )}
              </div>
            );
          })}
        </div>

        {allJudged && (
          <div style={{marginTop:16, textAlign:'center'}}>
            <button 
              className="btn btn-host" 
              onClick={() => { setJudgedPlayers({}); onNext(); }}
              style={{padding:'12px 20px', fontSize:16}}
            >
              {reviewIndex + 1 >= FINAL_QUESTIONS ? 'Zum Endergebnis ‚Üí' : 'N√§chste Final-Frage ‚Üí'}
            </button>
          </div>
        )}
      </div>
    );
  }

  /****************************************
   * PLAYER VIEW
   ****************************************/
  function PlayerView({ gameId, playerId }){
    const [game,setGame] = useState(null);
    const [meta,setMeta] = useState(null);
    const [player,setPlayer] = useState(null);
    const [timeLeft,setTimeLeft] = useState(0);
    const [poisonModalOpen, setPoisonModalOpen] = useState(false);
    const [poisonTargets, setPoisonTargets] = useState([]);
    const [boostModalOpen, setBoostModalOpen] = useState(false);
    const [shieldModalOpen, setShieldModalOpen] = useState(false);
    const [tradeModalOpen, setTradeModalOpen] = useState(false);
    const [tradeStep, setTradeStep] = useState('selectItem');
    const [selectedTradeItem, setSelectedTradeItem] = useState(null);
    const [bonusItemModalOpen, setBonusItemModalOpen] = useState(false);
    const [bonusCategoryModalOpen, setBonusCategoryModalOpen] = useState(false);
    const [candidateCategories, setCandidateCategories] = useState([]);
    const [finalAnswer, setFinalAnswer] = useState('');

    useEffect(() => {
      if(playerId && gameId) {
        sessionStorage.setItem(`quiz_pid_${gameId}`, playerId);
        localStorage.setItem(`quiz_pid_${gameId}`, playerId);
      }
    }, [playerId, gameId]);

    useEffect(()=>{
      const gRef = db.ref(`games/${gameId}`);
      gRef.on('value', snap => setGame(snap.val()));
      const mRef = db.ref(`games/${gameId}/meta`);
      mRef.on('value', snap => setMeta(snap.val()));
      const pRef = db.ref(`games/${gameId}/players/${playerId}`);
      pRef.on('value', snap => setPlayer(snap.val()));
      return ()=> { gRef.off(); mRef.off(); pRef.off(); };
    },[gameId, playerId]);

    useEffect(()=>{
      if(!meta){ setTimeLeft(0); return; }
      
      if(meta.phase === 'question' && meta.questionStartTime){
        const tick = ()=>{ 
          const elapsed = Math.floor((Date.now() - meta.questionStartTime)/1000); 
          setTimeLeft(Math.max(0, QUESTION_TIME - elapsed)); 
        };
        tick();
        const t = setInterval(tick, 500);
        return ()=> clearInterval(t);
      } else if(meta.phase === 'finalQuestion' && meta.finalQuestionStartTime){
        const tick = ()=>{ 
          const elapsed = Math.floor((Date.now() - meta.finalQuestionStartTime)/1000); 
          setTimeLeft(Math.max(0, FINAL_TIME - elapsed)); 
        };
        tick();
        const t = setInterval(tick, 500);
        return ()=> clearInterval(t);
      } else {
        setTimeLeft(0);
      }
    },[meta?.questionStartTime, meta?.finalQuestionStartTime, meta?.phase]);

    useEffect(()=>{
      if(!game || !meta || !player) return;
      if(meta.phase !== 'roundSummary'){
        setBonusItemModalOpen(false);
        setBonusCategoryModalOpen(false);
        setCandidateCategories([]);
        return;
      }

      const playersArr = Object.entries(game.players || {}).map(([pid,p])=>({pid,...p}));
      if(playersArr.length === 0) return;
      const minScore = Math.min(...playersArr.map(p => p.score || 0));
      const lastPlayers = playersArr.filter(p => (p.score || 0) === minScore).map(p => p.pid);
      const finishedRoundNumber = (meta.round || 1) - 1;

      if (finishedRoundNumber < 1 || finishedRoundNumber >= TOTAL_ROUNDS) {
        setBonusItemModalOpen(false);
        setBonusCategoryModalOpen(false);
        return;
      }

      const canChooseCategory = finishedRoundNumber === 1 || finishedRoundNumber === 2;

      if(lastPlayers.includes(playerId) && (player.lastRoundBonus !== finishedRoundNumber)){
        setBonusItemModalOpen(true);
      } else {
        setBonusItemModalOpen(false);
      }
    },[game, meta, player, playerId]);

    if(!game || !meta || !player) return <div className="min-h-screen flex items-center justify-center">Warte auf Spiel...</div>;

    const qIndex = meta.questionIndex || 0;
    const question = (game.questions || [])[qIndex];

    const openBoostModal = () => {
      const entries = Object.entries(game.players || {}).map(([pid,p]) => ({ pid, name: p.name }));
      setPoisonTargets(entries);
      setBoostModalOpen(true);
    };

    const sendBoostTo = async (targetPid) => {
      setBoostModalOpen(false);
      if(!(player.items && player.items.boost > 0)) { alert('Kein Boost verf√ºgbar'); return; }
      if(player.currentAnswer !== null && player.currentAnswer !== undefined && targetPid === playerId){ 
        alert('Boost muss vor der Antwort aktiviert werden.'); 
        return; 
      }
      const updates = {};
      updates[`games/${gameId}/players/${playerId}/items/boost`] = (player.items.boost - 1);
      updates[`games/${gameId}/players/${targetPid}/activeEffects/boost`] = true;
      updates[`games/${gameId}/players/${targetPid}/activeEffects/boostTarget`] = targetPid;
      
      const actionRef = db.ref(`games/${gameId}/meta/actions/${qIndex}`);
      const actionsSnap = await actionRef.get();
      const existingActions = actionsSnap.exists() ? actionsSnap.val() : [];
      existingActions.push({ type:'boost', from: playerId, to: targetPid, target: targetPid, ts: Date.now() });
      await actionRef.set(existingActions);
      await db.ref().update(updates);
    };

    const openShieldModal = () => {
      const entries = Object.entries(game.players || {}).map(([pid,p]) => ({ pid, name: p.name }));
      setPoisonTargets(entries);
      setShieldModalOpen(true);
    };

    const sendShieldTo = async (targetPid) => {
      setShieldModalOpen(false);
      if(!(player.items && player.items.shield > 0)) { alert('Kein Schild verf√ºgbar'); return; }
      const updates = {};
      updates[`games/${gameId}/players/${playerId}/items/shield`] = (player.items.shield - 1);
      updates[`games/${gameId}/players/${targetPid}/activeEffects/shield`] = true;
      updates[`games/${gameId}/players/${targetPid}/activeEffects/shieldTarget`] = targetPid;

      const actionRef = db.ref(`games/${gameId}/meta/actions/${qIndex}`);
      const actionsSnap = await actionRef.get();
      const existingActions = actionsSnap.exists() ? actionsSnap.val() : [];
      existingActions.push({ type:'shield', from: playerId, to: targetPid, target: targetPid, ts: Date.now() });
      await actionRef.set(existingActions);
      await db.ref().update(updates);
    };

    const openPoisonModal = ()=>{ 
      const entries = Object.entries(game.players || {}).filter(([pid]) => pid !== playerId).map(([pid,p]) => ({ pid, name: p.name })); 
      setPoisonTargets(entries); 
      setPoisonModalOpen(true); 
    };

    const sendPoisonTo = async (targetPid) => {
      setPoisonModalOpen(false);
      if(!(player.items && player.items.poison > 0)) { alert('Kein Gift verf√ºgbar'); return; }
      const updates = {};
      updates[`games/${gameId}/players/${playerId}/items/poison`] = (player.items.poison - 1);
      const actionRef = db.ref(`games/${gameId}/meta/actions/${qIndex}`);
      const targetSnap = await db.ref(`games/${gameId}/players/${targetPid}`).get();
      if(!targetSnap.exists()){ await db.ref().update(updates); return; }
      const targetData = targetSnap.val();
      const targetShield = targetData.activeEffects && targetData.activeEffects.shield;
      const actionsSnap = await actionRef.get();
      const existingActions = actionsSnap.exists() ? actionsSnap.val() : [];
      if(targetShield){
        existingActions.push({ type:'poison', from: playerId, to: targetPid, blocked: true, ts: Date.now() });
        await actionRef.set(existingActions);
        await db.ref().update(updates);
        return;
      } else {
        const prev = (targetData.activeEffects && Array.isArray(targetData.activeEffects.poisonedBy)) ? targetData.activeEffects.poisonedBy : [];
        const next = [...prev, playerId];
        updates[`games/${gameId}/players/${targetPid}/activeEffects/poisonedBy`] = next;
        existingActions.push({ type:'poison', from: playerId, to: targetPid, blocked: false, ts: Date.now() });
        await actionRef.set(existingActions);
        await db.ref().update(updates);
        return;
      }
    };

    const openTradeModal = () => {
      if(player.hasTraded) {
        alert('Du hast in dieser Runde bereits gehandelt!');
        return;
      }
      setTradeStep('selectItem');
      setSelectedTradeItem(null);
      setTradeModalOpen(true);
    };

    const selectTradeItem = (item) => {
      if(!(player.items && player.items[item] > 0)) {
        alert(`Kein ${item} verf√ºgbar`);
        return;
      }
      setSelectedTradeItem(item);
      setTradeStep('selectPlayer');
    };

    const sendTradeTo = async (targetPid) => {
      setTradeModalOpen(false);
      if(!selectedTradeItem) return;
      if(!(player.items && player.items[selectedTradeItem] > 0)) {
        alert('Item nicht verf√ºgbar');
        return;
      }

      const updates = {};
      updates[`games/${gameId}/players/${playerId}/items/${selectedTradeItem}`] = (player.items[selectedTradeItem] - 1);
      updates[`games/${gameId}/players/${playerId}/hasTraded`] = true;
      
      const targetSnap = await db.ref(`games/${gameId}/players/${targetPid}`).get();
      if(targetSnap.exists()) {
        const targetData = targetSnap.val();
        const targetItemCount = (targetData.items && targetData.items[selectedTradeItem]) ? targetData.items[selectedTradeItem] : 0;
        updates[`games/${gameId}/players/${targetPid}/items/${selectedTradeItem}`] = targetItemCount + 1;
      }

      const actionRef = db.ref(`games/${gameId}/meta/actions/${qIndex}`);
      const actionsSnap = await actionRef.get();
      const existingActions = actionsSnap.exists() ? actionsSnap.val() : [];
      existingActions.push({ type:'trade', from: playerId, to: targetPid, item: selectedTradeItem, ts: Date.now() });
      await actionRef.set(existingActions);
      await db.ref().update(updates);
    };

    const submitFinalAnswer = async () => {
      if(!finalAnswer.trim()) {
        alert('Bitte gib eine Antwort ein');
        return;
      }
      const finalQIndex = meta.finalQuestionIndex || 0;
      await db.ref(`games/${gameId}/players/${playerId}/finalAnswers/${finalQIndex}`).set(finalAnswer.trim());
      setFinalAnswer('');
    };

    if(meta.phase === 'finalIntro'){
      if(!player.isFinalist){
        return (
          <div className="min-h-screen flex items-center justify-center" style={{padding:20, background:'var(--bg)'}}>
            <div className="card" style={{maxWidth:500, textAlign:'center'}}>
              <h2 style={{fontSize:24, fontWeight:900, color:'var(--rtl-orange)'}}>üèÜ Finale</h2>
              <p style={{marginTop:12, color:'var(--muted)'}}>
                Du hast es leider nicht ins Finale geschafft. Die Top 2 Spieler bereiten sich jetzt vor!
              </p>
              <p style={{marginTop:12, fontWeight:900}}>Dein Endstand: {player.score || 0} Punkte</p>
            </div>
          </div>
        );
      }

      const markReady = async () => {
        await db.ref(`games/${gameId}/players/${playerId}/finalistReady`).set(true);
      };

      return (
        <div className="min-h-screen" style={{padding:20, background:'var(--bg)'}}>
          <div style={{padding:24, background:'rgba(255,255,255,0.01)', maxWidth:700, margin:'0 auto'}} className="card">
            <div style={{textAlign:'center'}}>
              <h2 style={{fontSize:32, fontWeight:900, color:'var(--rtl-orange)', marginBottom:12}}>üèÜ FINALE</h2>
              <p style={{fontSize:18, color:'var(--muted)', marginBottom:20}}>
                Gl√ºckwunsch! Du hast dich qualifiziert!
              </p>
            </div>

            <div style={{padding:20, background:'rgba(255,102,0,0.1)', borderLeft:'3px solid var(--rtl-orange)', marginBottom:24}}>
              <h3 style={{fontSize:20, fontWeight:900, marginBottom:12}}>‚ö° Finale-Regeln</h3>
              <ul style={{fontSize:16, lineHeight:1.8, listStylePosition:'inside'}}>
                <li><strong>5 offene Fragen</strong> nacheinander</li>
                <li><strong>60 Sekunden Zeit</strong> pro Frage</li>
                <li><strong>Jede richtige Antwort = {FINAL_POINTS} Punkte</strong> (doppelt!)</li>
                <li><strong>Keine Items</strong> verf√ºgbar</li>
                <li>Antworten werden manuell bewertet</li>
              </ul>
            </div>

            <div style={{padding:16, background:'rgba(255,255,255,0.02)', textAlign:'center', marginBottom:20}}>
              <div style={{fontSize:14, color:'var(--muted)', marginBottom:8}}>Dein aktueller Stand:</div>
              <div style={{fontSize:28, fontWeight:900, color:'var(--rtl-green)'}}>{player.score || 0} Punkte</div>
            </div>

            {player.finalistReady ? (
              <div style={{padding:16, background:'rgba(34,197,94,0.1)', textAlign:'center'}}>
                <div style={{fontSize:18, fontWeight:900, color:'var(--rtl-green)'}}>‚úì Du bist bereit!</div>
                <p style={{marginTop:8, color:'var(--muted)'}}>Warte auf den anderen Finalisten...</p>
              </div>
            ) : (
              <button 
                className="btn btn-host w-full" 
                onClick={markReady}
                style={{padding:'16px', fontSize:18}}
              >
                ‚úì Ich bin bereit!
              </button>
            )}
          </div>
        </div>
      );
    }

    if(meta.phase === 'question' && question){
      const hasAnswered = player.currentAnswer !== null && player.currentAnswer !== undefined;
      const boostAvailable = (player.items && player.items.boost > 0);
      const poisonAvailable = (player.items && player.items.poison > 0);
      const shieldAvailable = (player.items && player.items.shield > 0);
      const canTrade = !player.hasTraded && ((player.items && player.items.boost > 0) || (player.items && player.items.poison > 0) || (player.items && player.items.shield > 0));

      const answerClick = async (i)=>{ 
        if(hasAnswered || timeLeft <= 0) return; 
        await db.ref(`games/${gameId}/players/${playerId}/currentAnswer`).set(i); 
      };

      const boostBtnClass = `item-btn ${(boostAvailable) ? '' : 'item-disabled'} ${ (player.activeEffects && player.activeEffects.boost) ? 'active' : '' }`;
      const poisonBtnClass = `item-btn ${(poisonAvailable) ? '' : 'item-disabled'} `;
      const shieldBtnClass = `item-btn ${(shieldAvailable) ? '' : 'item-disabled'} ${ (player.activeEffects && player.activeEffects.shield) ? 'shield-active' : '' }`;
      const tradeBtnClass = `item-btn ${(canTrade) ? '' : 'item-disabled'}`;

      return (
        <div className="min-h-screen" style={{padding:20, background:'var(--bg)'}}>
          <div style={{padding:16, background:'rgba(255,255,255,0.01)'}} className="card">
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
              <div>Runde {meta.round}/{TOTAL_ROUNDS}</div>
              <div style={{fontSize:18, fontWeight:900, color:'var(--rtl-orange)'}}>{timeLeft}s</div>
            </div>

            <h3 style={{fontSize:18,fontWeight:900, marginTop:12}}>{question.question}</h3>

            <div style={{marginTop:12, display:'grid', gap:10}}>
              {question.answers.map((ans,i)=>{
                const disabled = hasAnswered || timeLeft <= 0;
                const isSelected = player.currentAnswer === i;
                const style = isSelected ? {background:'var(--rtl-purple)', color:'#fff', borderColor:'var(--rtl-purple)', borderRadius:10, padding:'10px 12px'} : {borderRadius:10, padding:'10px 12px', background:'rgba(255,255,255,0.02)'};
                return (
                  <button key={i} disabled={disabled} onClick={()=>answerClick(i)} style={style} className="p-3 font-bold">
                    <div style={{display:'flex', gap:10, alignItems:'center'}}>
                      <div style={{fontWeight:900}}>{String.fromCharCode(65+i)}.</div>
                      <div>{ans}</div>
                    </div>
                  </button>
                );
              })}
            </div>

            <div style={{marginTop:14}}>
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10}}>
                <div style={{color: 'var(--muted)', fontSize:14}}>{player.currentAnswer === null ? "Noch nicht geantwortet" : `Du hast Antwort ${String.fromCharCode(65 + player.currentAnswer)} gew√§hlt`}</div>
                <div style={{fontWeight:900, color:'var(--rtl-green)'}}>Punkte: {player.score || 0}</div>
              </div>

              <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:8}}>
                <button className={boostBtnClass} disabled={!boostAvailable} onClick={openBoostModal} title={'Boost: W√§hle ein Ziel (sich selbst oder anderen Spieler)'}>
                  <span style={{fontSize:18}}>üî•</span><span style={{fontWeight:900, minWidth:28, textAlign:'center'}}>{player.items && player.items.boost ? player.items.boost : 0}</span>
                </button>

                <button className={poisonBtnClass} disabled={!poisonAvailable} onClick={openPoisonModal} title={'Vergiften: w√§hle ein Ziel'}>
                  <span style={{fontSize:18}}>‚ò†Ô∏è</span><span style={{fontWeight:900, minWidth:28, textAlign:'center'}}>{player.items && player.items.poison ? player.items.poison : 0}</span>
                </button>

                <button className={shieldBtnClass} disabled={!shieldAvailable} onClick={openShieldModal} title={'Schild: W√§hle ein Ziel (sich selbst oder anderen Spieler)'} style={{gridColumn:'1 / -1'}}>
                  <span style={{fontSize:18}}>üõ°</span><span style={{fontWeight:900, minWidth:28, textAlign:'center'}}>{player.items && player.items.shield ? player.items.shield : 0}</span>
                </button>

                <button className={tradeBtnClass} disabled={!canTrade} onClick={openTradeModal} title={'Handel: Gib ein Item an einen anderen Spieler (einmal pro Runde)'} style={{gridColumn:'1 / -1', background: canTrade ? 'var(--rtl-green)' : 'rgba(255,255,255,0.02)', color: canTrade ? 'white' : 'var(--tile)'}}>
                  <span style={{fontSize:18}}>ü§ù</span><span style={{fontWeight:900}}>Handeln {player.hasTraded ? '(‚úì verwendet)' : ''}</span>
                </button>
              </div>
            </div>

            <div style={{marginTop:10, color:'var(--muted)', fontSize:13}}>
              ‚ÑπÔ∏è Items sind Ressourcen f√ºr das gesamte Spiel.<br/>
              üî• Boost: W√§hle Ziel (x1.5 bei richtiger Antwort). Bei sich selbst: vor der Antwort aktivieren!<br/>
              ‚ò†Ô∏è Gift: W√§hle Gegner (-20 Punkte).<br/>
              üõ° Schild: W√§hle Ziel (sch√ºtzt vor Gift).<br/>
              ü§ù Handeln: Gib ein Item an einen Mitspieler (1√ó pro Frage).
            </div>
          </div>

          {boostModalOpen && (
            <div className="modal-backdrop">
              <div className="modal-card" style={{maxWidth:420}}>
                <div style={{fontWeight:900, fontSize:18, marginBottom:12}}>Wen willst du boosten?</div>
                <div style={{display:'flex', flexDirection:'column', gap:8}}>
                  {poisonTargets.length === 0 ? <div style={{color:'var(--muted)'}}>Keine Spieler verf√ºgbar</div> : poisonTargets.map(t => (
                    <button key={t.pid} onClick={()=>sendBoostTo(t.pid)} className="btn btn-host" style={{width:'100%', padding:'12px 16px', fontSize:16, display:'flex', justifyContent:'space-between'}}>
                      {t.name} {t.pid === playerId && '(Du)'}
                      <span style={{opacity:0.9}}>Boosten</span>
                    </button>
                  ))}
                  <button className="btn btn-join" onClick={()=>setBoostModalOpen(false)} style={{width:'100%', padding:'12px 16px', fontSize:16}}>Abbrechen</button>
                </div>
              </div>
            </div>
          )}

          {shieldModalOpen && (
            <div className="modal-backdrop">
              <div className="modal-card" style={{maxWidth:420}}>
                <div style={{fontWeight:900, fontSize:18, marginBottom:12}}>Wen willst du sch√ºtzen?</div>
                <div style={{display:'flex', flexDirection:'column', gap:8}}>
                  {poisonTargets.length === 0 ? <div style={{color:'var(--muted)'}}>Keine Spieler verf√ºgbar</div> : poisonTargets.map(t => (
                    <button key={t.pid} onClick={()=>sendShieldTo(t.pid)} className="btn btn-host" style={{width:'100%', padding:'12px 16px', fontSize:16, display:'flex', justifyContent:'space-between'}}>
                      {t.name} {t.pid === playerId && '(Du)'}
                      <span style={{opacity:0.9}}>Sch√ºtzen</span>
                    </button>
                  ))}
                  <button className="btn btn-join" onClick={()=>setShieldModalOpen(false)} style={{width:'100%', padding:'12px 16px', fontSize:16}}>Abbrechen</button>
                </div>
              </div>
            </div>
          )}

          {poisonModalOpen && (
            <div className="modal-backdrop">
              <div className="modal-card" style={{maxWidth:420}}>
                <div style={{fontWeight:900, fontSize:18, marginBottom:12}}>Wen willst du vergiften?</div>
                <div style={{display:'flex', flexDirection:'column', gap:8}}>
                  {poisonTargets.length === 0 ? <div style={{color:'var(--muted)'}}>Keine anderen Spieler verf√ºgbar</div> : poisonTargets.map(t => (
                    <button key={t.pid} onClick={()=>sendPoisonTo(t.pid)} className="btn btn-host" style={{width:'100%', padding:'12px 16px', fontSize:16, display:'flex', justifyContent:'space-between'}}>{t.name}<span style={{opacity:0.9}}>Vergiften</span></button>
                  ))}
                  <button className="btn btn-join" onClick={()=>setPoisonModalOpen(false)} style={{width:'100%', padding:'12px 16px', fontSize:16}}>Abbrechen</button>
                </div>
              </div>
            </div>
          )}

          {tradeModalOpen && tradeStep === 'selectItem' && (
            <div className="modal-backdrop">
              <div className="modal-card" style={{maxWidth:420}}>
                <div style={{fontWeight:900, fontSize:18, marginBottom:12}}>Welches Item willst du handeln?</div>
                <div style={{display:'flex', flexDirection:'column', gap:8}}>
                  {(player.items && player.items.boost > 0) && (
                    <button onClick={()=>selectTradeItem('boost')} className="btn btn-host" style={{width:'100%', padding:'12px 16px', fontSize:16}}>
                      üî• Boost ({player.items.boost})
                    </button>
                  )}
                  {(player.items && player.items.poison > 0) && (
                    <button onClick={()=>selectTradeItem('poison')} className="btn btn-host" style={{width:'100%', padding:'12px 16px', fontSize:16}}>
                      ‚ò†Ô∏è Gift ({player.items.poison})
                    </button>
                  )}
                  {(player.items && player.items.shield > 0) && (
                    <button onClick={()=>selectTradeItem('shield')} className="btn btn-host" style={{width:'100%', padding:'12px 16px', fontSize:16}}>
                      üõ° Schild ({player.items.shield})
                    </button>
                  )}
                  <button className="btn btn-join" onClick={()=>setTradeModalOpen(false)} style={{width:'100%', padding:'12px 16px', fontSize:16}}>Abbrechen</button>
                </div>
              </div>
            </div>
          )}

          {tradeModalOpen && tradeStep === 'selectPlayer' && (
            <div className="modal-backdrop">
              <div className="modal-card" style={{maxWidth:420}}>
                <div style={{fontWeight:900, fontSize:18, marginBottom:12}}>An wen willst du {selectedTradeItem === 'boost' ? 'üî• Boost' : selectedTradeItem === 'poison' ? '‚ò†Ô∏è Gift' : 'üõ° Schild'} geben?</div>
                <div style={{display:'flex', flexDirection:'column', gap:8}}>
                  {Object.entries(game.players || {}).filter(([pid]) => pid !== playerId).map(([pid,p]) => (
                    <button key={pid} onClick={()=>sendTradeTo(pid)} className="btn btn-host" style={{width:'100%', padding:'12px 16px', fontSize:16}}>
                      {p.name}
                    </button>
                  ))}
                  <button className="btn btn-join" onClick={()=>{setTradeStep('selectItem'); setSelectedTradeItem(null);}} style={{width:'100%', padding:'12px 16px', fontSize:16}}>Zur√ºck</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    if(meta.phase === 'finalQuestion'){
      if(!player.isFinalist){
        return (
          <div className="min-h-screen flex items-center justify-center" style={{padding:20, background:'var(--bg)'}}>
            <div className="card" style={{maxWidth:500, textAlign:'center'}}>
              <h2 style={{fontSize:24, fontWeight:900, color:'var(--rtl-orange)'}}>üèÜ Finale l√§uft</h2>
              <p style={{marginTop:12, color:'var(--muted)'}}>
                Du hast es leider nicht ins Finale geschafft. Die Top 2 Spieler k√§mpfen jetzt um den Sieg!
              </p>
              <p style={{marginTop:12, fontWeight:900}}>Dein Endstand: {player.score || 0} Punkte</p>
            </div>
          </div>
        );
      }

      const finalQIndex = meta.finalQuestionIndex || 0;
      const finalQuestion = (game.finalQuestions || [])[finalQIndex];
      const hasAnswered = player.finalAnswers && player.finalAnswers[finalQIndex];

      return (
        <div className="min-h-screen" style={{padding:20, background:'var(--bg)'}}>
          <div style={{padding:16, background:'rgba(255,255,255,0.01)'}} className="card">
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
              <div>
                <div style={{fontSize:20, fontWeight:900, color:'var(--rtl-orange)'}}>üèÜ FINALE</div>
                <div style={{color:'var(--muted)'}}>Frage {finalQIndex + 1} von {FINAL_QUESTIONS}</div>
              </div>
              <div style={{fontSize:18, fontWeight:900, color:'var(--rtl-orange)'}}>{timeLeft}s</div>
            </div>

            <h3 style={{fontSize:20, fontWeight:900, marginTop:16}}>{finalQuestion?.question}</h3>
            
            <div style={{marginTop:16, padding:12, background:'rgba(255,102,0,0.1)', borderLeft:'3px solid var(--rtl-orange)'}}>
              <div style={{fontWeight:700, marginBottom:8}}>‚ö†Ô∏è Finale-Regeln:</div>
              <ul style={{marginLeft:20, color:'var(--muted)', fontSize:14}}>
                <li>Offene Frage - tippe deine Antwort ein</li>
                <li>Jede richtige Antwort = {FINAL_POINTS} Punkte (doppelt!)</li>
                <li>60 Sekunden Zeit</li>
                <li>Keine Items verf√ºgbar</li>
              </ul>
            </div>

            {hasAnswered ? (
              <div style={{marginTop:16, padding:16, background:'rgba(34,197,94,0.1)', textAlign:'center', borderLeft:'3px solid var(--rtl-green)'}}>
                <div style={{fontSize:18, fontWeight:900, color:'var(--rtl-green)'}}>‚úì Antwort abgegeben</div>
                <p style={{marginTop:8, color:'var(--muted)'}}>Warte auf die Auswertung...</p>
              </div>
            ) : (
              <div style={{marginTop:16}}>
                <input 
                  className="w-full p-3" 
                  placeholder="Deine Antwort eingeben..." 
                  value={finalAnswer}
                  onChange={e => setFinalAnswer(e.target.value)}
                  disabled={timeLeft === 0}
                  style={{fontSize:16}}
                />
                <button 
                  className="btn btn-host w-full mt-3" 
                  onClick={submitFinalAnswer}
                  disabled={!finalAnswer.trim() || timeLeft === 0}
                  style={{padding:'12px', fontSize:16}}
                >
                  Antwort abschicken
                </button>
              </div>
            )}

            <div style={{marginTop:16, display:'flex', justifyContent:'space-between', padding:12, background:'rgba(255,255,255,0.02)'}}>
              <div style={{fontWeight:700}}>Dein aktueller Stand:</div>
              <div style={{fontWeight:900, color:'var(--rtl-green)', fontSize:18}}>{player.score || 0} Punkte</div>
            </div>
          </div>
        </div>
      );
    }

    if(meta.phase === 'finalReview'){
      if(!player.isFinalist){
        return (
          <div className="min-h-screen flex items-center justify-center" style={{padding:20, background:'var(--bg)'}}>
            <div className="card" style={{maxWidth:500, textAlign:'center'}}>
              <h2 style={{fontSize:24, fontWeight:900, color:'var(--rtl-orange)'}}>üèÜ Finale - Auswertung</h2>
              <p style={{marginTop:12, color:'var(--muted)'}}>
                Der Host wertet gerade die Antworten aus...
              </p>
              <p style={{marginTop:12, fontWeight:900}}>Dein Endstand: {player.score || 0} Punkte</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen" style={{padding:20, background:'var(--bg)'}}>
          <div style={{padding:16, background:'rgba(255,255,255,0.01)'}} className="card">
            <h2 style={{fontSize:24, fontWeight:900, color:'var(--rtl-orange)', textAlign:'center'}}>üèÜ Auswertung l√§uft...</h2>
            <p style={{marginTop:12, color:'var(--muted)', textAlign:'center'}}>
              Der Host bewertet gerade deine Antworten.
            </p>
            
            <div style={{marginTop:24, padding:20, background:'rgba(255,255,255,0.02)', textAlign:'center'}}>
              <div style={{fontSize:16, color:'var(--muted)', marginBottom:8}}>Dein Live-Stand:</div>
              <div style={{fontSize:36, fontWeight:900, color:'var(--rtl-green)'}}>{player.score || 0}</div>
              <div style={{fontSize:14, color:'var(--muted)', marginTop:4}}>Punkte</div>
            </div>

            <div style={{marginTop:16, padding:12, background:'rgba(255,102,0,0.05)', textAlign:'center'}}>
              <div style={{color:'var(--muted)', fontSize:14}}>
                ‚è≥ Bitte warten w√§hrend der Host die Antworten pr√ºft...
              </div>
            </div>
          </div>
        </div>
      );
    }

    if(meta.phase === 'results' && question){
      const wasCorrect = player.currentAnswer === question.correct;
      const poisonedBy = (player.activeEffects && player.activeEffects.poisonedBy) ? player.activeEffects.poisonedBy : [];
      const shieldActive = player.activeEffects && player.activeEffects.shield;
      const isCategoryChooser = meta.categoryChooserForRound === playerId;
      let poisonMsg = '';
      if(poisonedBy.length === 0){
        poisonMsg = shieldActive ? 'Schild aktiv ‚Äî kein Gift' : 'Nicht vergiftet';
      } else {
        const names = poisonedBy.map(id => { 
          const found = Object.entries(game.players || {}).find(([k]) => k === id); 
          return found ? found[1].name : id; 
        });
        poisonMsg = `Vergiftet von: ${names.join(', ')}`;
      }

      return (
        <div className="min-h-screen" style={{padding:20, background:'var(--bg)'}}>
          <div style={{padding:16}} className="card">
            <h3 style={{fontSize:26, fontWeight:900, color: wasCorrect ? 'var(--rtl-green)' : '#ff6b6b'}}>{wasCorrect ? 'Richtig! üéâ' : 'Falsch üòï'}</h3>
            <p style={{marginTop:8}}>Richtige Antwort: <strong style={{color:'var(--rtl-green)'}}>{question.answers[question.correct]}</strong></p>
            <p style={{marginTop:8}}>Punkte diese Frage: <strong style={{color:'var(--rtl-green)'}}>{player.lastPoints || 0}</strong></p>
            {isCategoryChooser && (
              <p style={{marginTop:8, color:'var(--rtl-orange)', fontWeight:900}}>‚≠ê Du bist Kategorie-W√§hler (+20% Bonus auf richtige Antworten)</p>
            )}
            <p style={{marginTop:8}}>Dein Punktestand: <strong style={{color:'var(--rtl-green)'}}>{player.score || 0}</strong></p>
            <p style={{marginTop:8, color:'var(--muted)'}}>Status: {poisonMsg}{shieldActive ? ' (Schild aktiv)' : ''}</p>
            <p style={{marginTop:8, color:'var(--muted)'}}>Warte auf den Host f√ºr die n√§chste Frage.</p>
          </div>
        </div>
      );
    }

    if(meta.phase === 'roundSummary' || meta.phase === 'finished'){
      const playersSorted = Object.entries(game.players || {}).map(([pid,p])=>({pid,...p})).sort((a,b)=>(b.score||0)-(a.score||0));
      const title = meta.phase === 'finished' ? 'üéâ Spiel beendet!' : `üèÜ Zwischenstand nach Runde ${meta.round - 1}`;
      const finishedRound = (meta.round || 1) - 1;
      const catState = meta.categoryState || { used: [], remaining: [] };
      const remaining = catState.remaining || [];
      const candidateCatsForThisPlayer = shuffle(remaining).slice(0,2);

      const pickBonusItem = async (choice) => {
        const updates = {};
        const currentCount = (player.items && player.items[choice]) ? player.items[choice] : 0;
        updates[`games/${gameId}/players/${playerId}/items/${choice}`] = currentCount + 1;
        updates[`games/${gameId}/players/${playerId}/lastRoundBonus`] = finishedRound;
        await db.ref().update(updates);
        setBonusItemModalOpen(false);

        const canChooseCategory = finishedRound === 1 || finishedRound === 2;
        if(!canChooseCategory) return;

        const metaSnap = await db.ref(`games/${gameId}/meta`).get();
        const metaVal = metaSnap.exists() ? metaSnap.val() : {};
        
        if (!metaVal.nextCategory) {
          let candidates = candidateCatsForThisPlayer;
          if(candidates.length === 0){
            const used = catState.used || [];
            candidates = shuffle(CATEGORY_LIST.filter(c => !used.includes(c))).slice(0,2);
          }
          setCandidateCategories(candidates);
          setBonusCategoryModalOpen(true);
        } else {
          setBonusCategoryModalOpen(false);
        }
      };

      const pickBonusCategory = async (cat) => {
        await db.ref(`games/${gameId}/meta`).update({ 
          nextCategory: cat,
          categoryChooserForRound: playerId 
        });
        setBonusCategoryModalOpen(false);
      };

      return (
        <div className="min-h-screen" style={{padding:20, background:'var(--bg)'}}>
          <div style={{padding:16}} className="card">
            <h3 style={{fontSize:20, fontWeight:900, color:'var(--rtl-orange)', textAlign:'center'}}>{title}</h3>
            <div style={{marginTop:12}}>
              {playersSorted.map((p,i)=>(
                <div key={p.pid} style={{display:'flex', justifyContent:'space-between', padding:'8px 0', borderBottom:'1px solid rgba(255,255,255,0.03)'}}>
                  <div style={{fontWeight:900}}>{i<3? (i===0?'ü•á':i===1?'ü•à':'ü•â') : `#${i+1}`} {p.name}</div>
                  <div style={{display:'flex', gap:12, alignItems:'center'}}>
                    {meta.phase !== 'finished' && (
                      <>
                        <div>üî•{(p.items && p.items.boost) ? p.items.boost : 0}</div>
                        <div>‚ò†Ô∏è{(p.items && p.items.poison) ? p.items.poison : 0}</div>
                        <div>üõ°{(p.items && p.items.shield) ? p.items.shield : 0}</div>
                      </>
                    )}
                    <div style={{fontWeight:900}}>{p.score || 0}</div>
                  </div>
                </div>
              ))}
            </div>
            <p style={{marginTop:12, color:'var(--muted)', textAlign:'center'}}>
              {meta.phase === 'finished' ? 'Warte auf den Host...' : 
               meta.round > TOTAL_ROUNDS ? (meta.finaleEnabled !== false ? 'Bereite dich auf das Finale vor!' : 'Das Spiel ist zu Ende!') : 
               'Host startet die n√§chste Runde, sobald er bereit ist.'}
            </p>
          </div>

          {bonusItemModalOpen && (
            <div className="modal-backdrop">
              <div className="modal-card" style={{maxWidth:420}}>
                <div style={{fontWeight:900, fontSize:18, marginBottom:12, textAlign:'center'}}>üéÅ Du liegst hinten ‚Äî w√§hle ein Bonus-Item</div>
                <div style={{display:'flex', flexDirection:'column', gap:10}}>
                  <button className="btn btn-host" onClick={()=>pickBonusItem('boost')} style={{width:'100%', padding:'12px 14px', fontSize:16}}>üî• Boost +1</button>
                  <button className="btn btn-host" onClick={()=>pickBonusItem('poison')} style={{width:'100%', padding:'12px 14px', fontSize:16}}>‚ò†Ô∏è Gift +1</button>
                  <button className="btn btn-host" onClick={()=>pickBonusItem('shield')} style={{width:'100%', padding:'12px 14px', fontSize:16}}>üõ° Schild +1</button>
                </div>
                <div style={{marginTop:12, textAlign:'center'}}>
                  <button className="btn btn-join" onClick={()=>setBonusItemModalOpen(false)} style={{width:'100%', padding:'12px 14px'}}>Sp√§ter</button>
                </div>
              </div>
            </div>
          )}

          {bonusCategoryModalOpen && (
            <div className="modal-backdrop">
              <div className="modal-card" style={{maxWidth:420}}>
                <div style={{fontWeight:900, fontSize:18, marginBottom:12, textAlign:'center'}}>üè∑Ô∏è W√§hle eine Kategorie f√ºr die n√§chste Runde</div>
                <div style={{fontSize:14, marginBottom:12, color:'var(--muted)', textAlign:'center'}}>
                  Als Kategorie-W√§hler erh√§ltst du +20% Bonus auf richtige Antworten in der n√§chsten Runde!
                </div>
                <div style={{display:'flex', flexDirection:'column', gap:10}}>
                  {(candidateCategories.length === 0 ? CATEGORY_LIST.slice(0,2) : candidateCategories).map(c => (
                    <button key={c} className="btn btn-host" onClick={()=>pickBonusCategory(c)} style={{width:'100%', padding:'12px 14px', fontSize:16}}>{c}</button>
                  ))}
                </div>
                <div style={{marginTop:12, textAlign:'center'}}>
                  <button className="btn btn-join" onClick={()=>setBonusCategoryModalOpen(false)} style={{width:'100%', padding:'12px 14px'}}>Random</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    return <div>Warte...</div>;
  }

  /****************************************
   * PLAYER JOIN
   ****************************************/
  function PlayerJoin({ joinGameId, onJoined }){
    const [name,setName] = useState('');
    const [error,setError] = useState('');

    const handleJoin = async ()=>{
      setError('');
      try{
        const snap = await db.ref(`games/${joinGameId}`).get();
        if(!snap.exists()){ setError('Spiel nicht gefunden'); return; }
        const pid = makePlayerId();
        const playerObj = {
          name,
          score: 0,
          currentAnswer: null,
          joinedAt: Date.now(),
          items: DEFAULT_ITEMS,
          activeEffects: { boost:false, boostTarget:null, shield:false, shieldTarget:null, poisonedBy: [] },
          lastPoints: 0,
          lastRoundBonus: null,
          hasTraded: false
        };
        await db.ref(`games/${joinGameId}/players/${pid}`).set(playerObj);
        sessionStorage.setItem(`quiz_pid_${joinGameId}`, pid);
        localStorage.setItem(`quiz_pid_${joinGameId}`, pid);
        onJoined(joinGameId, pid, name);
      }catch(e){ console.error(e); setError('Fehler beim Beitreten'); }
    };

    return (
      <div className="min-h-screen flex items-center justify-center p-6" style={{background:'var(--bg)'}}>
        <div style={{maxWidth:420, width:'100%'}} className="card">
          <div style={{display:'flex', gap:12, alignItems:'center'}}>
            <RTLLogo size="sm" />
            <div style={{fontWeight:900}}>AdAlliance</div>
          </div>
          <h2 style={{fontSize:20, fontWeight:900, marginTop:8, color:'var(--rtl-orange)'}}>Spiel beitreten</h2>
          <p>Code: <span style={{fontFamily:'monospace'}}>{joinGameId}</span></p>
          <input className="w-full p-3 mb-3" placeholder="Dein Name" value={name} onChange={e=>setName(e.target.value)} />
          <button className="btn btn-host w-full" onClick={handleJoin} disabled={!name}>Beitreten</button>
          {error && <div style={{color:'#ff6b6b', marginTop:8}}>{error}</div>}
        </div>
      </div>
    );
  }

  /****************************************
   * MAIN APP
   ****************************************/
  function App(){
    const [mode,setMode] = useState('start');
    const [gameId,setGameId] = useState('');
    const [playerId,setPlayerId] = useState('');
    const [playerName,setPlayerName] = useState('');
    const [hostName,setHostName] = useState('');

    useEffect(()=>{
      const params = new URLSearchParams(window.location.search);
      const joinCode = params.get('join');
      if(joinCode){ 
        const savedPid = sessionStorage.getItem(`quiz_pid_${joinCode}`) || localStorage.getItem(`quiz_pid_${joinCode}`);
        if(savedPid) {
          db.ref(`games/${joinCode}/players/${savedPid}`).once('value', snap => {
            if(snap.exists()) {
              setGameId(joinCode);
              setPlayerId(savedPid);
              setPlayerName(snap.val().name || 'Spieler');
              setMode('playerGame');
            } else {
              setMode('playerJoin'); 
              setGameId(joinCode);
            }
          });
        } else {
          setMode('playerJoin'); 
          setGameId(joinCode);
        }
      }
    },[]);

    const handleCreate = async (name)=>{
      setHostName(name);
      const gid = randomGameID();
      setGameId(gid);
      await db.ref(`games/${gid}/meta`).set({ phase: 'lobby', finaleEnabled: true });
      setMode('hostLobby');
    };

    const handleJoin = async (name, code)=>{
      try{
        const snap = await db.ref(`games/${code}`).get();
        if(!snap.exists()){ alert('Spiel nicht gefunden'); return; }
        const pid = makePlayerId();
        const playerObj = {
          name,
          score: 0,
          currentAnswer: null,
          joinedAt: Date.now(),
          items: DEFAULT_ITEMS,
          activeEffects: { boost:false, boostTarget:null, shield:false, shieldTarget:null, poisonedBy: [] },
          lastPoints: 0,
          lastRoundBonus: null,
          hasTraded: false
        };
        await db.ref(`games/${code}/players/${pid}`).set(playerObj);
        sessionStorage.setItem(`quiz_pid_${code}`, pid);
        localStorage.setItem(`quiz_pid_${code}`, pid);
        setGameId(code); setPlayerId(pid); setPlayerName(name); setMode('playerGame');
      }catch(e){ console.error(e); alert('Fehler'); }
    };

    const handlePlayerJoined = (code,pid,name) => { 
      sessionStorage.setItem(`quiz_pid_${code}`, pid);
      localStorage.setItem(`quiz_pid_${code}`, pid);
      setGameId(code); 
      setPlayerId(pid); 
      setPlayerName(name); 
      setMode('playerGame'); 
    };

    return (
      <>
        {mode === 'start' && <StartScreen onCreate={handleCreate} onJoin={handleJoin} />}
        {mode === 'hostLobby' && <HostScreen gameId={gameId} hostName={hostName} />}
        {mode === 'playerGame' && <PlayerView gameId={gameId} playerId={playerId} />}
        {mode === 'playerJoin' && <PlayerJoin joinGameId={gameId} onJoined={handlePlayerJoined} />}
      </>
    );
  }
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>
</html>













