<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTL AdAlliance Quiz - Multiplayer</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --rtl-red: #E31F23;
      --rtl-black: #0a0a0a;
      --rtl-dark-bg: #131313;
      --rtl-white: #ffffff;
      --rtl-accent-1: #00B0E8;
      --rtl-accent-2: #FFB81C;
      --rtl-orange: #FF6600;
      --rtl-purple: #7B2CBF;
    }

    * {
      border-radius: 0 !important;
    }

    html, body, #root {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }

    body {
      background: var(--rtl-black);
      color: var(--rtl-white);
    }

    .host-screen {
      display: flex;
      flex-direction: row;
      gap: 24px;
      align-items: stretch;
      height: 100%;
      padding: 24px;
      box-sizing: border-box;
      background: var(--rtl-black);
    }

    .host-main {
      flex: 2;
      background: var(--rtl-dark-bg);
      border: 1px solid var(--rtl-red);
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .host-main::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--rtl-orange), var(--rtl-red), var(--rtl-purple));
      z-index: 1;
    }

    .countdown-badge {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 100px;
      height: 100px;
      background: conic-gradient(var(--rtl-red) 0deg, var(--rtl-red) var(--progress), rgba(227, 31, 35, 0.1) var(--progress), rgba(227, 31, 35, 0.1) 360deg);
      border: 2px solid var(--rtl-red);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 900;
      z-index: 10;
    }

    .countdown-badge.warning {
      background: conic-gradient(var(--rtl-accent-2) 0deg, var(--rtl-accent-2) var(--progress), rgba(255, 184, 28, 0.1) var(--progress), rgba(255, 184, 28, 0.1) 360deg);
      border-color: var(--rtl-accent-2);
    }

    .countdown-badge.danger {
      background: conic-gradient(#FF4444 0deg, #FF4444 var(--progress), rgba(255, 68, 68, 0.1) var(--progress), rgba(255, 68, 68, 0.1) 360deg);
      border-color: #FF4444;
      animation: pulse-danger 0.5s infinite;
    }

    @keyframes pulse-danger {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .question-container {
      width: 100%;
      padding: 30px;
      margin-bottom: 40px;
    }

    .question-text {
      font-size: 3.5rem;
      font-weight: 900;
      color: var(--rtl-white);
      margin-bottom: 50px;
      line-height: 1.2;
      letter-spacing: -0.5px;
    }

    .answers-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      width: 100%;
      max-width: 1200px;
    }

    .answer-btn {
      position: relative;
      padding: 30px;
      background: var(--rtl-dark-bg);
      border: 2px solid var(--rtl-accent-1);
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      cursor: default;
      transition: all 0.3s ease;
      color: white;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.5px;
    }

    .answer-btn.highlighted {
      background: var(--rtl-red);
      border-color: var(--rtl-red);
      transform: scale(1.02);
    }

    .results-section {
      width: 100%;
    }

    .result-title {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 30px;
      color: var(--rtl-red);
    }

    .correct-answer {
      font-size: 2rem;
      margin-bottom: 40px;
      padding: 20px;
      background: var(--rtl-dark-bg);
      border-left: 3px solid var(--rtl-red);
    }

    .result-answer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      width: 100%;
    }

    .result-answer {
      padding: 20px;
      border-left: 3px solid;
      font-weight: 600;
      background: var(--rtl-dark-bg);
    }

    .result-answer.correct {
      border-left-color: var(--rtl-red);
    }

    .result-answer.incorrect {
      border-left-color: var(--rtl-accent-1);
    }

    .result-voters {
      font-size: 0.9rem;
      margin-top: 10px;
      color: rgba(255, 255, 255, 0.7);
    }

    .host-side {
      flex: 1;
      background: var(--rtl-dark-bg);
      padding: 24px;
      overflow: auto;
      border: 1px solid rgba(227, 31, 35, 0.3);
    }

    .leaderboard-title {
      font-size: 1.3rem;
      font-weight: 900;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--rtl-red);
      border-bottom: 2px solid var(--rtl-red);
      padding-bottom: 10px;
    }

    .player-item {
      display: flex;
      justify-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(227, 31, 35, 0.1);
      margin-bottom: 10px;
      border-left: 3px solid var(--rtl-red);
      transition: all 0.2s ease;
    }

    .player-item:hover {
      background: rgba(227, 31, 35, 0.15);
      transform: translateX(5px);
    }

    .player-rank {
      font-weight: 900;
      font-size: 1.1rem;
      color: var(--rtl-accent-2);
      margin-right: 10px;
      min-width: 25px;
    }

    .player-name {
      flex: 1;
      font-weight: 600;
    }

    .player-score {
      font-weight: 900;
      color: var(--rtl-red);
      font-size: 1.1rem;
    }

    .round-summary {
      text-align: center;
    }

    .summary-title {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 30px;
      color: var(--rtl-red);
    }

    .summary-podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      height: 300px;
      margin: 30px 0;
    }

    .podium-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .podium-name {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .podium-score {
      font-weight: 900;
      font-size: 1.4rem;
      color: var(--rtl-red);
    }

    .podium-bar {
      width: 100%;
      background: var(--rtl-dark-bg);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      color: white;
      font-weight: 900;
      font-size: 2rem;
      border-top: 3px solid;
    }

    .podium-bar.gold {
      border-top-color: var(--rtl-red);
      background: linear-gradient(180deg, rgba(227, 31, 35, 0.3), rgba(227, 31, 35, 0.1));
      height: 250px;
    }

    .podium-bar.silver {
      border-top-color: var(--rtl-accent-1);
      background: linear-gradient(180deg, rgba(0, 176, 232, 0.2), rgba(0, 176, 232, 0.05));
      height: 200px;
    }

    .podium-bar.bronze {
      border-top-color: var(--rtl-accent-2);
      background: linear-gradient(180deg, rgba(255, 184, 28, 0.2), rgba(255, 184, 28, 0.05));
      height: 150px;
    }

    .finished-title {
      font-size: 3.5rem;
      font-weight: 900;
      margin-bottom: 40px;
      color: var(--rtl-red);
    }

    .finished-list {
      max-height: 400px;
      overflow-y: auto;
    }

    /* RTL Logo SVG */
    .rtl-logo-svg {
      height: 60px;
      width: auto;
      display: inline-block;
    }

    .rtl-logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .rtl-logo-text {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--rtl-white);
      letter-spacing: 1px;
    }

    .start-card {
      max-width: 600px;
      width: 100%;
      background: var(--rtl-dark-bg);
      padding: 40px;
      border: 2px solid var(--rtl-red);
      position: relative;
      overflow: hidden;
    }

    .start-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--rtl-orange), var(--rtl-red), var(--rtl-purple));
    }

    .btn-host {
      background: var(--rtl-red) !important;
      color: white !important;
    }

    .btn-host:hover {
      background: #c91c1f !important;
    }

    .btn-join {
      background: var(--rtl-accent-1) !important;
      color: white !important;
    }

    .btn-join:hover {
      background: #0095cc !important;
    }

    input {
      background: rgba(255, 255, 255, 0.05) !important;
      color: white !important;
      border: 1px solid var(--rtl-red) !important;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5) !important;
    }
  </style>
</head>
<body class="bg-black text-white">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /************ CONFIG ************/
  const TOTAL_ROUNDS = 4;
  const QUESTIONS_PER_ROUND = 10;
  const QUESTION_TIME = 40;

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCsxAEsivsJVFVcnerdAWezFpruoCv7Z2I",
    authDomain: "qiuz-64055.firebaseapp.com",
    databaseURL: "https://qiuz-64055-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "qiuz-64055",
    storageBucket: "qiuz-64055.firebasestorage.app",
    messagingSenderId: "605853616985",
    appId: "1:605853616985:web:95579b246a10d89ba51a48"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Question Pool
  const QUESTION_POOL = [
    { question: "Was ist die Hauptstadt von √ñsterreich?", answers: ["Wien","Graz","Salzburg","Innsbruck"], correct: 0 },
    { question: "Welcher Planet ist der gr√∂√üte?", answers: ["Mars","Saturn","Jupiter","Neptun"], correct: 2 },
    { question: "Wer malte die Mona Lisa?", answers: ["Picasso","Van Gogh","Da Vinci","Monet"], correct: 2 },
    { question: "In welchem Jahr fiel die Berliner Mauer?", answers: ["1987","1989","1991","1993"], correct: 1 },
    { question: "Was ist die chemische Formel f√ºr Wasser?", answers: ["CO2","H2O","O2","NaCl"], correct: 1 },
    { question: "Welches ist der l√§ngste Fluss der Welt?", answers: ["Nil","Amazonas","Yangtze","Mississippi"], correct: 0 },
    { question: "Wie viele Kontinente gibt es?", answers: ["5","6","7","8"], correct: 2 },
    { question: "Welches Tier ist das schnellste an Land?", answers: ["L√∂we","Gepard","Antilope","Pferd"], correct: 1 },
    { question: "Wer schrieb 'Romeo und Julia'?", answers: ["Goethe","Shakespeare","Schiller","Kafka"], correct: 1 },
    { question: "Welches ist das gr√∂√üte S√§ugetier?", answers: ["Elefant","Blauwal","Giraffe","Nilpferd"], correct: 1 },
    { question: "In welchem Land steht der Eiffelturm?", answers: ["Italien","Spanien","Frankreich","Deutschland"], correct: 2 },
    { question: "Was ist 7 x 8?", answers: ["54","56","58","64"], correct: 1 },
    { question: "Welche Farbe hat ein Smaragd?", answers: ["Rot","Blau","Gr√ºn","Gelb"], correct: 2 },
    { question: "Wie hei√üt die Hauptstadt von Deutschland?", answers: ["M√ºnchen","Hamburg","Berlin","K√∂ln"], correct: 2 },
    { question: "Welcher Ozean ist der gr√∂√üte?", answers: ["Atlantik","Indischer","Pazifik","Arktis"], correct: 2 },
    { question: "Wie viele Beine hat eine Spinne?", answers: ["6","8","10","12"], correct: 1 },
    { question: "Was ist die Hauptstadt der USA?", answers: ["New York","Los Angeles","Chicago","Washington D.C."], correct: 3 },
    { question: "Welches Instrument hat 88 Tasten?", answers: ["Gitarre","Klavier","Orgel","Keyboard"], correct: 1 },
    { question: "In welcher Stadt steht die Freiheitsstatue?", answers: ["Boston","New York","Chicago","Miami"], correct: 1 },
    { question: "Wie viele Seiten hat ein W√ºrfel?", answers: ["4","6","8","10"], correct: 1 },
    { question: "Welches Gas atmen wir ein?", answers: ["Sauerstoff","Stickstoff","Kohlendioxid","Helium"], correct: 0 },
    { question: "Wie hei√üt der h√∂chste Berg der Welt?", answers: ["K2","Mount Everest","Kilimandscharo","Mont Blanc"], correct: 1 },
    { question: "Welcher Planet ist der Erde am n√§chsten?", answers: ["Mars","Venus","Merkur","Jupiter"], correct: 1 },
    { question: "Wie viele Bundesl√§nder hat √ñsterreich?", answers: ["7","9","11","13"], correct: 1 },
    { question: "Was ist die Quadratwurzel von 64?", answers: ["6","8","10","12"], correct: 1 },
    { question: "Welches Tier legt Eier?", answers: ["Katze","Hund","Huhn","Kuh"], correct: 2 },
    { question: "Wie viele Minuten hat eine Stunde?", answers: ["30","45","60","90"], correct: 2 },
    { question: "Welche Farbe entsteht aus Rot und Gelb?", answers: ["Gr√ºn","Orange","Lila","Braun"], correct: 1 },
    { question: "In welchem Jahr begann das 21. Jahrhundert?", answers: ["1999","2000","2001","2002"], correct: 2 },
    { question: "Wie hei√üt die Hauptstadt von Spanien?", answers: ["Barcelona","Madrid","Valencia","Sevilla"], correct: 1 },
    { question: "Welches Element hat das Symbol 'Au'?", answers: ["Silber","Gold","Kupfer","Eisen"], correct: 1 },
    { question: "Welcher Fluss flie√üt durch London?", answers: ["Seine","Donau","Themse","Rhein"], correct: 2 },
    { question: "Was ist die kleinste Primzahl?", answers: ["0","1","2","3"], correct: 2 },
    { question: "Welches Land hat die meisten Einwohner?", answers: ["Indien","China","USA","Indonesien"], correct: 1 },
    { question: "Wie viele Spieler hat eine Fu√üballmannschaft auf dem Feld?", answers: ["9","10","11","12"], correct: 2 },
    { question: "Welche Sprache wird in Brasilien gesprochen?", answers: ["Spanisch","Portugiesisch","Franz√∂sisch","Englisch"], correct: 1 },
    { question: "Wie hei√üt das chemische Symbol f√ºr Wasserstoff?", answers: ["H","He","O","W"], correct: 0 },
    { question: "Was ist die Hauptstadt von Frankreich?", answers: ["Paris","Lyon","Marseille","Bordeaux"], correct: 0 },
    { question: "Wie viele Tage hat ein Schaltjahr?", answers: ["365","366","364","367"], correct: 1 },
    { question: "Was ist 12 √ó 12?", answers: ["144","124","132","156"], correct: 0 },
  ];

  // RTL Logo SVG Component
  function RTLLogo({ size = 'md' }) {
    const sizeMap = {
      sm: 40,
      md: 60,
      lg: 100
    };
    const h = sizeMap[size];
    const w = (h / 300) * 1520;

    return (
      <svg viewBox="0 0 1520 300" height={h} width={w} xmlns="http://www.w3.org/2000/svg">
        {/* Orange R */}
        <rect x="0" y="0" width="490" height="300" fill="#FF6600"/>
        <text x="245" y="220" fontSize="200" fontWeight="900" fill="white" textAnchor="middle" fontFamily="Arial, sans-serif">R</text>
        
        {/* Red T */}
        <rect x="515" y="0" width="490" height="300" fill="#E31F23"/>
        <text x="760" y="220" fontSize="200" fontWeight="900" fill="white" textAnchor="middle" fontFamily="Arial, sans-serif">T</text>
        
        {/* Purple L */}
        <rect x="1030" y="0" width="490" height="300" fill="#7B2CBF"/>
        <text x="1275" y="220" fontSize="200" fontWeight="900" fill="white" textAnchor="middle" fontFamily="Arial, sans-serif">L</text>
      </svg>
    );
  }

  // Helper Functions
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function generateQuestions() {
    const needed = TOTAL_ROUNDS * QUESTIONS_PER_ROUND;
    let pool = [...QUESTION_POOL];
    while (pool.length < needed) pool = pool.concat(QUESTION_POOL);
    pool = shuffle(pool).slice(0, needed).map((q, idx) => ({ id: idx, ...q }));
    return pool;
  }

  function randomGameID() {
    return Math.random().toString(36).substr(2, 6).toUpperCase();
  }

  function makePlayerId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
  }

  function qrUrlForGame(gameId) {
    const url = `${window.location.origin}${window.location.pathname}?join=${gameId}`;
    return `https://quickchart.io/qr?text=${encodeURIComponent(url)}&size=300`;
  }

  // START SCREEN
  function StartScreen({ onCreate, onJoin }) {
    const [name, setName] = useState('');
    const [code, setCode] = useState('');

    return (
      <div className="min-h-screen flex items-center justify-center px-6" style={{ background: 'var(--rtl-black)' }}>
        <div className="start-card">
          <div className="rtl-logo-container">
            <RTLLogo size="md" />
            <span className="rtl-logo-text">AdAlliance Quiz</span>
          </div>
          
          <h1 className="text-4xl font-bold mb-4 text-center" style={{color: 'var(--rtl-red)'}}>üéØ Quiz Master</h1>
          <p className="text-sm mb-6 text-center" style={{color: 'rgba(245, 245, 245, 0.7)'}}>
            Host erstellt Spiel oder Spieler treten per Code/QR bei
          </p>

          <input className="w-full p-3 mb-4" placeholder="Dein Name" value={name} onChange={e => setName(e.target.value)} />

          <div className="flex gap-3 mb-3">
            <button 
              className="flex-1 btn-host px-4 py-3 font-bold disabled:opacity-60" 
              disabled={!name} 
              onClick={() => onCreate(name)}
            >
              üé¨ Host werden
            </button>
            <input className="w-40 p-2" placeholder="Code" value={code} onChange={e => setCode(e.target.value.toUpperCase())} />
            <button 
              className="btn-join px-3 py-3 font-bold disabled:opacity-60" 
              disabled={!name || !code} 
              onClick={() => onJoin(name, code)}
            >
              Beitreten
            </button>
          </div>

          <p className="text-xs text-center" style={{color: 'rgba(227, 31, 35, 0.8)'}}>‚ÑπÔ∏è Host ist Quizmaster und wird nicht als Spieler gez√§hlt</p>
        </div>
      </div>
    );
  }

  // HOST CONTROLLER
  function HostController({ gameId, meta, startNextRound }) {
    const [players, setPlayers] = useState({});
    
    useEffect(() => {
      const ref = db.ref(`games/${gameId}/players`);
      ref.on('value', snap => setPlayers(snap.val() || {}));
      return () => ref.off();
    }, [gameId]);

    const startGame = async () => {
      const questions = generateQuestions();
      const metaObj = {
        phase: 'question',
        questionIndex: 0,
        round: 1,
        questionStartTime: Date.now(),
        nextQuestionIndex: null
      };
      await db.ref(`games/${gameId}/questions`).set(questions);
      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const updates = {};
      Object.keys(pObj).forEach(pid => {
        updates[`games/${gameId}/players/${pid}/score`] = 0;
        updates[`games/${gameId}/players/${pid}/currentAnswer`] = null;
      });
      await db.ref().update(updates);
      await db.ref(`games/${gameId}/meta`).set(metaObj);
    };

    const nextQuestion = async () => {
      const snap = await db.ref(`games/${gameId}/meta`).get();
      const metaVal = snap.val();
      const cur = metaVal?.questionIndex || 0;
      const next = cur + 1;
      const isGameEnd = next >= TOTAL_ROUNDS * QUESTIONS_PER_ROUND;
      const isEndOfRound = (cur + 1) % QUESTIONS_PER_ROUND === 0;

      if (isGameEnd) {
        await db.ref(`games/${gameId}/meta`).update({ phase: 'finished' });
      } else if (isEndOfRound) {
        await db.ref(`games/${gameId}/meta`).update({ phase: 'roundSummary', nextQuestionIndex: next });
      } else {
        const pSnap = await db.ref(`games/${gameId}/players`).get();
        const pObj = pSnap.val() || {};
        const updates = {};
        Object.keys(pObj).forEach(pid => updates[`games/${gameId}/players/${pid}/currentAnswer`] = null);
        await db.ref().update(updates);
        await db.ref(`games/${gameId}/meta`).update({
          questionIndex: next,
          phase: 'question',
          questionStartTime: Date.now(),
          round: Math.floor(next / QUESTIONS_PER_ROUND) + 1
        });
      }
    };

    if (!meta) {
      return <div className="text-center p-3" style={{color: 'rgba(245, 245, 245, 0.7)'}}>Warten...</div>;
    }

    return (
      <div className="space-y-3 bg-black/50 p-4 border border-red-600">
        <div className="flex items-center justify-between mb-4">
          <div>
            <div className="text-sm" style={{color: 'rgba(245, 245, 245, 0.9)'}}>Phase: <strong style={{color: 'var(--rtl-red)'}}>{meta.phase}</strong></div>
            <div className="text-sm" style={{color: 'rgba(245, 245, 245, 0.9)'}}>Runde: <strong style={{color: 'var(--rtl-red)'}}>{meta.round || 1}/{TOTAL_ROUNDS}</strong></div>
            <div className="text-sm" style={{color: 'rgba(245, 245, 245, 0.9)'}}>Frage: <strong style={{color: 'var(--rtl-red)'}}>{(meta.questionIndex || 0) + 1}/{TOTAL_ROUNDS * QUESTIONS_PER_ROUND}</strong></div>
          </div>
          <div className="text-right">
            <div className="text-xs" style={{color: 'rgba(245, 245, 245, 0.8)'}}>üë• Spieler: {Object.keys(players).length}</div>
          </div>
        </div>

        <div className="flex gap-2 flex-wrap">
          {(meta.phase === 'lobby' || !meta.phase) && <button className="btn-host px-4 py-2 text-sm font-bold" onClick={startGame}>Spiel starten</button>}
          {meta.phase === 'results' && <button className="btn-join px-4 py-2 text-sm font-bold" onClick={nextQuestion}>N√§chste Frage</button>}
          {meta.phase === 'roundSummary' && <button className="btn-join px-4 py-2 text-sm font-bold" onClick={startNextRound}>N√§chste Runde</button>}
          {meta.phase === 'finished' && <div className="text-green-300 font-bold px-3 py-2 text-sm">‚úì Spiel beendet</div>}
        </div>
      </div>
    );
  }

  // HOST FULLSCREEN VIEW
  function HostScreen({ gameId, hostName }) {
    const [game, setGame] = useState(null);
    const [meta, setMeta] = useState(null);
    const [timeLeft, setTimeLeft] = useState(0);
    const timerRef = useRef(null);

    useEffect(() => {
      const gRef = db.ref(`games/${gameId}`);
      gRef.on('value', snap => setGame(snap.val()));
      const mRef = db.ref(`games/${gameId}/meta`);
      mRef.on('value', snap => setMeta(snap.val()));
      return () => { gRef.off(); mRef.off(); clearInterval(timerRef.current); };
    }, [gameId]);

    useEffect(() => {
      if (!meta || meta.phase !== 'question' || !meta.questionStartTime) { setTimeLeft(0); return; }
      const tick = async () => {
        const elapsed = Math.floor((Date.now() - meta.questionStartTime) / 1000);
        const rem = Math.max(0, QUESTION_TIME - elapsed);
        setTimeLeft(rem);
        
        // Automatisch Ergebnisse anzeigen wenn Zeit abl√§uft
        if (rem === 0) {
          try {
            const snap = await db.ref(`games/${gameId}`).get();
            const g = snap.val();
            if (!g) return;
            const qIndex = g.meta?.questionIndex || 0;
            const q = (g.questions || [])[qIndex];
            if (!q) return;
            const playerObj = g.players || {};
            const updates = {};
            Object.entries(playerObj).forEach(([pid, p]) => {
              const ans = p.currentAnswer;
              const correct = typeof ans === 'number' && ans === q.correct;
              const newScore = (p.score || 0) + (correct ? 100 : 0);
              updates[`games/${gameId}/players/${pid}/score`] = newScore;
            });
            await db.ref().update(updates);
            await db.ref(`games/${gameId}/meta`).update({ phase: 'results' });
          } catch (err) { console.error(err); }
        }
      };
      tick();
      clearInterval(timerRef.current);
      timerRef.current = setInterval(tick, 500);
      return () => clearInterval(timerRef.current);
    }, [meta?.phase, meta?.questionStartTime, gameId]);

    const startNextRound = async () => {
      if (!meta) return;
      const nextIndex = meta.nextQuestionIndex ?? (meta.questionIndex ?? 0);
      const round = Math.floor(nextIndex / QUESTIONS_PER_ROUND) + 1;
      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const updates = {};
      Object.keys(pObj).forEach(pid => updates[`games/${gameId}/players/${pid}/currentAnswer`] = null);
      await db.ref().update(updates);
      await db.ref(`games/${gameId}/meta`).update({
        questionIndex: nextIndex,
        phase: 'question',
        questionStartTime: Date.now(),
        round: round,
        nextQuestionIndex: null
      });
    };

    if (!meta || !game) return <div className="min-h-screen flex items-center justify-center">Lade Spiel...</div>;

    const qIndex = meta.questionIndex || 0;
    const question = (game.questions || [])[qIndex];
    const playersArr = Object.entries(game.players || {}).map(([pid, p]) => ({ pid, ...p })).sort((a, b) => (b.score || 0) - (a.score || 0));

    const countdownProgress = (timeLeft / QUESTION_TIME) * 360;
    const countdownClass = timeLeft <= 10 ? 'danger' : timeLeft <= 20 ? 'warning' : '';

    return (
      <div className="min-h-screen host-screen">
        <div className="host-main">
          {meta.phase === 'lobby' && (
            <div>
              <div className="rtl-logo-container mb-6">
                <RTLLogo size="lg" />
                <span className="rtl-logo-text text-2xl">AdAlliance Quiz</span>
              </div>
              <h2 className="text-5xl font-bold mb-2">‚è≥ Warte auf Spieler</h2>
              <p className="text-2xl mt-8">Spielcode:</p>
              <p className="font-mono bg-white text-black px-6 py-2 text-3xl font-bold mt-2">{gameId}</p>
            </div>
          )}

          {meta.phase === 'question' && question && (
            <div className="question-container">
              <div 
                className={`countdown-badge ${countdownClass}`}
                style={{'--progress': `${countdownProgress}deg`}}
              >
                {timeLeft}
              </div>
              <div className="question-text">{question.question}</div>
              <div className="answers-grid">
                {question.answers.map((a, i) => (
                  <div key={i} className="answer-btn">
                    <span>{String.fromCharCode(65 + i)}. {a}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {meta.phase === 'results' && question && (
            <div className="results-section">
              <h2 className="result-title">üìä Ergebnisse</h2>
              <div className="correct-answer">
                ‚úì Richtige Antwort: <strong>{question.answers[question.correct]}</strong>
              </div>
              <div className="result-answer-grid">
                {question.answers.map((a, i) => {
                  const voters = playersArr.filter(p => p.currentAnswer === i);
                  const isCorrect = i === question.correct;
                  return (
                    <div key={i} className={`result-answer ${isCorrect ? 'correct' : 'incorrect'}`}>
                      <div className="font-bold">{String.fromCharCode(65 + i)}. {a}</div>
                      <div className="result-voters">
                        {voters.length > 0 ? voters.map(p => p.name).join(', ') : '(Niemand)'}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {meta.phase === 'roundSummary' && (
            <div className="round-summary">
              <h2 className="summary-title">üèÜ Zwischenstand Runde {meta.round}</h2>
              <div className="summary-podium">
                {playersArr.slice(0, 3).map((p, i) => {
                  const podiumClass = i === 0 ? 'gold' : i === 1 ? 'silver' : 'bronze';
                  const position = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â';
                  return (
                    <div key={p.pid} className="podium-item">
                      <div>
                        <div className="text-3xl">{position}</div>
                        <div className="podium-name">{p.name}</div>
                        <div className="podium-score">{p.score || 0} Pts</div>
                      </div>
                      <div className={`podium-bar ${podiumClass}`}>
                        {p.score || 0}
                      </div>
                    </div>
                  );
                })}
              </div>
              {playersArr.length > 3 && (
                <div className="mt-8">
                  {playersArr.slice(3).map((p, i) => (
                    <div key={p.pid} className="flex justify-between items-center p-3 bg-white/5 mb-2 border border-red-600/30">
                      <div className="text-lg font-bold">#{i + 4} {p.name}</div>
                      <div className="text-lg font-bold" style={{color: 'var(--rtl-red)'}}>{p.score || 0} pts</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {meta.phase === 'finished' && (
            <div>
              <h2 className="finished-title">üéâ Spiel beendet!</h2>
              <div className="finished-list">
                {playersArr.map((p, i) => (
                  <div key={p.pid} className="flex justify-between items-center bg-white/5 p-4 mb-3 border-l-4" style={{borderLeftColor: 'var(--rtl-red)'}}>
                    <div className="text-2xl font-bold">#{i + 1} {p.name}</div>
                    <div className="text-2xl font-extrabold" style={{color: 'var(--rtl-red)'}}>{p.score || 0} pts</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        <div className="host-side">
          <HostController gameId={gameId} meta={meta} startNextRound={startNextRound} />

          <div className="mb-6 mt-6">
            <h3 className="leaderboard-title">üèÖ Spieler & Punkte</h3>
            <div className="space-y-2 max-h-72 overflow-auto">
              {playersArr.map((p, idx) => (
                <div key={p.pid} className="player-item">
                  <div className="player-rank">#{idx + 1}</div>
                  <div className="player-name text-sm">{p.name}</div>
                  <div className="player-score text-sm">{p.score || 0}</div>
                </div>
              ))}
            </div>
          </div>

          <div>
            <h3 className="leaderboard-title mt-6">‚ÑπÔ∏è Code & QR</h3>
            <div className="text-sm bg-black/50 p-3 border border-red-600/30 mb-2">
              <span className="font-mono bg-white text-black px-2 py-1 text-xs">{gameId}</span>
            </div>
            <img src={qrUrlForGame(gameId)} alt="QR Code" className="w-full" />
          </div>
        </div>
      </div>
    );
  }

  // PLAYER VIEW (Smartphone)
  function PlayerView({ gameId, playerId }) {
    const [game, setGame] = useState(null);
    const [meta, setMeta] = useState(null);
    const [player, setPlayer] = useState(null);
    const [timeLeft, setTimeLeft] = useState(0);

    useEffect(() => {
      const gRef = db.ref(`games/${gameId}`);
      gRef.on('value', snap => setGame(snap.val()));
      const mRef = db.ref(`games/${gameId}/meta`);
      mRef.on('value', snap => setMeta(snap.val()));
      const pRef = db.ref(`games/${gameId}/players/${playerId}`);
      pRef.on('value', snap => setPlayer(snap.val()));
      return () => { gRef.off(); mRef.off(); pRef.off(); };
    }, [gameId, playerId]);

    useEffect(() => {
      if (!meta || meta.phase !== 'question' || !meta.questionStartTime) { setTimeLeft(0); return; }
      const tick = () => {
        const elapsed = Math.floor((Date.now() - meta.questionStartTime) / 1000);
        setTimeLeft(Math.max(0, QUESTION_TIME - elapsed));
      };
      tick();
      const t = setInterval(tick, 500);
      return () => clearInterval(t);
    }, [meta?.questionStartTime, meta?.phase]);

    if (!game || !meta || !player) return <div className="min-h-screen flex items-center justify-center">Warte auf Spiel...</div>;

    const qIndex = meta.questionIndex || 0;
    const question = (game.questions || [])[qIndex];

    if (meta.phase === 'lobby') {
      return (
        <div className="min-h-screen flex items-center justify-center p-6" style={{ background: 'var(--rtl-black)' }}>
          <div className="bg-white/5 p-6 w-full max-w-md text-center border-2" style={{borderColor: 'var(--rtl-red)'}}>
            <div className="rtl-logo-container mb-4">
              <RTLLogo size="sm" />
              <span className="rtl-logo-text">AdAlliance</span>
            </div>
            <h2 className="text-2xl font-bold mb-2" style={{color: 'var(--rtl-red)'}}>Warte auf Start</h2>
            <p className="mb-2">Spielcode: <span className="font-mono bg-white text-black px-2 py-1">{gameId}</span></p>
            <p className="text-sm">Bitte warte, bis der Host das Spiel startet.</p>
            <p className="text-sm mt-3">Dein Name: <strong>{player.name}</strong></p>
          </div>
        </div>
      );
    }

    if (meta.phase === 'question' && question) {
      const hasAnswered = player.currentAnswer !== null && player.currentAnswer !== undefined;
      return (
        <div className="min-h-screen flex items-center justify-center p-6" style={{ background: 'var(--rtl-black)' }}>
          <div className="bg-white/5 p-6 w-full max-w-md border-2" style={{borderColor: 'var(--rtl-red)'}}>
            <div className="flex justify-between items-center mb-4">
              <div>Runde {meta.round}/{TOTAL_ROUNDS}</div>
              <div className="text-lg font-bold" style={{color: 'var(--rtl-red)'}}>{timeLeft}s</div>
            </div>
            <h3 className="text-xl font-bold mb-4">{question.question}</h3>

            <div className="grid gap-3">
              {question.answers.map((ans, i) => {
                const disabled = hasAnswered || timeLeft <= 0;
                const isSelected = player.currentAnswer === i;
                return (
                  <button
                    key={i}
                    disabled={disabled}
                    onClick={() => db.ref(`games/${gameId}/players/${playerId}/currentAnswer`).set(i)}
                    className={`p-3 font-bold text-left transition-all ${disabled ? (isSelected ? 'text-white' : 'bg-white/10 text-white/80') : 'text-white'}`}
                    style={disabled && isSelected ? {background: 'var(--rtl-red)', color: 'white', border: '2px solid var(--rtl-red)'} : disabled ? {border: '2px solid var(--rtl-red)', background: 'transparent'} : {background: 'var(--rtl-accent-1)', color: 'white', border: '2px solid var(--rtl-accent-1)'}}
                  >
                    {String.fromCharCode(65 + i)}. {ans}
                  </button>
                );
              })}
            </div>

            <div className="mt-4 text-sm">
              {player.currentAnswer === null ? "Noch nicht geantwortet" : `Du hast Antwort ${String.fromCharCode(65 + player.currentAnswer)} gew√§hlt`}
            </div>
            <div className="mt-4 text-sm">Punkte: <strong style={{color: 'var(--rtl-red)'}}>{player.score || 0}</strong></div>
          </div>
        </div>
      );
    }

    if (meta.phase === 'results' && question) {
      const wasCorrect = player.currentAnswer === question.correct;
      return (
        <div className="min-h-screen flex items-center justify-center p-6" style={{ background: 'var(--rtl-black)' }}>
          <div className="bg-white/5 p-6 w-full max-w-md text-center border-2" style={{borderColor: 'var(--rtl-red)'}}>
            <h3 className="text-3xl font-bold mb-3" style={{color: wasCorrect ? 'var(--rtl-red)' : '#FF6B6B'}}>{wasCorrect ? 'Richtig! üéâ' : 'Falsch üòï'}</h3>
            <p className="mb-2">Richtige Antwort: <strong>{question.answers[question.correct]}</strong></p>
            <p className="mb-2">Dein Punktestand: <strong style={{color: 'var(--rtl-red)'}}>{player.score || 0}</strong></p>
            <p className="text-sm">Warte auf den Host f√ºr die n√§chste Frage.</p>
          </div>
        </div>
      );
    }

    if (meta.phase === 'roundSummary') {
      const playersSorted = Object.values(game.players || {}).sort((a, b) => (b.score || 0) - (a.score || 0));
      return (
        <div className="min-h-screen flex items-center justify-center p-6" style={{ background: 'var(--rtl-black)' }}>
          <div className="bg-white/5 p-6 w-full max-w-md border-2" style={{borderColor: 'var(--rtl-red)'}}>
            <h3 className="text-2xl font-bold mb-3" style={{color: 'var(--rtl-red)'}}>Zwischenstand Runde {meta.round}</h3>
            <div className="bg-white/10 p-3 mb-3">
              {playersSorted.map((p, i) => <div key={i} className="flex justify-between py-1">{i + 1}. {p.name} <span style={{color: 'var(--rtl-red)'}}>{p.score || 0} pts</span></div>)}
            </div>
            <p className="text-sm">Host startet die n√§chste Runde, sobald er bereit ist.</p>
          </div>
        </div>
      );
    }

    if (meta.phase === 'finished') {
      const playersSorted = Object.values(game.players || {}).sort((a, b) => (b.score || 0) - (a.score || 0));
      return (
        <div className="min-h-screen flex items-center justify-center p-6" style={{ background: 'var(--rtl-black)' }}>
          <div className="bg-white/5 p-6 w-full max-w-md border-2" style={{borderColor: 'var(--rtl-red)'}}>
            <h3 className="text-3xl font-bold mb-3" style={{color: 'var(--rtl-red)'}}>Spiel beendet</h3>
            <div className="bg-white/10 p-3 mb-3">
              {playersSorted.map((p, i) => <div key={i} className="flex justify-between py-1">{i + 1}. {p.name} <span style={{color: 'var(--rtl-red)'}}>{p.score || 0} pts</span></div>)}
            </div>
          </div>
        </div>
      );
    }

    return <div>Warte...</div>;
  }

  // Player Join Screen
  function PlayerJoin({ joinGameId, onJoined }) {
    const [name, setName] = useState('');
    const [error, setError] = useState('');

    const handleJoin = async () => {
      setError('');
      try {
        const snap = await db.ref(`games/${joinGameId}`).get();
        if (!snap.exists()) { setError('Spiel nicht gefunden'); return; }
        const pid = makePlayerId();
        const playerObj = { name, score: 0, currentAnswer: null, joinedAt: Date.now() };
        await db.ref(`games/${joinGameId}/players/${pid}`).set(playerObj);
        localStorage.setItem(`quiz_player_${joinGameId}`, pid);
        localStorage.setItem(`quiz_name_${joinGameId}`, name);
        onJoined(joinGameId, pid, name);
      } catch (err) { console.error(err); setError('Fehler beim Beitreten'); }
    };

    return (
      <div className="min-h-screen flex items-center justify-center p-6" style={{ background: 'var(--rtl-black)' }}>
        <div className="bg-white/5 p-6 w-full max-w-md border-2" style={{borderColor: 'var(--rtl-red)'}}>
          <div className="rtl-logo-container mb-4">
            <RTLLogo size="sm" />
            <span className="rtl-logo-text">AdAlliance</span>
          </div>
          <h2 className="text-2xl font-bold mb-3 text-center" style={{color: 'var(--rtl-red)'}}>Spiel beitreten</h2>
          <p className="mb-3 text-sm text-center">Code: <span className="font-mono">{joinGameId}</span></p>
          <input className="w-full p-3 mb-3" placeholder="Dein Name" value={name} onChange={e => setName(e.target.value)} />
          <button className="btn-join px-4 py-3 w-full font-bold" onClick={handleJoin} disabled={!name}>Beitreten</button>
          {error && <div className="text-red-300 mt-3 text-sm">{error}</div>}
        </div>
      </div>
    );
  }

  // APP MAIN
  function App() {
    const [mode, setMode] = useState('start');
    const [gameId, setGameId] = useState('');
    const [playerId, setPlayerId] = useState('');
    const [playerName, setPlayerName] = useState('');
    const [hostName, setHostName] = useState('');

    useEffect(() => {
      const params = new URLSearchParams(window.location.search);
      const joinCode = params.get('join');
      if (joinCode) {
        setMode('playerJoin');
        setGameId(joinCode);
      }
    }, []);

    const handleCreate = async (name) => {
      setHostName(name);
      const gid = randomGameID();
      setGameId(gid);
      await db.ref(`games/${gid}/meta`).set({ phase: 'lobby' });
      setMode('hostLobby');
    };

    const handleJoin = async (name, code) => {
      try {
        const snap = await db.ref(`games/${code}`).get();
        if (!snap.exists()) { alert('Spiel nicht gefunden'); return; }
        const pid = makePlayerId();
        const playerObj = { name, score: 0, currentAnswer: null, joinedAt: Date.now() };
        await db.ref(`games/${code}/players/${pid}`).set(playerObj);
        setGameId(code);
        setPlayerId(pid);
        setPlayerName(name);
        setMode('playerGame');
      } catch (err) { console.error(err); alert('Fehler'); }
    };

    const handlePlayerJoined = (code, pid, name) => {
      setGameId(code);
      setPlayerId(pid);
      setPlayerName(name);
      setMode('playerGame');
    };

    return (
      <>
        {mode === 'start' && <StartScreen onCreate={handleCreate} onJoin={handleJoin} />}
        {mode === 'hostLobby' && <HostScreen gameId={gameId} hostName={hostName} />}
        {mode === 'playerGame' && <PlayerView gameId={gameId} playerId={playerId} />}
        {mode === 'playerJoin' && <PlayerJoin joinGameId={gameId} onJoined={handlePlayerJoined} />}
      </>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
