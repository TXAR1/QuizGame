<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multiplayer Quiz (Host & Smartphones)</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    html,body,#root { height: 100%; }
    
    /* Host full-screen styles for large display */
    .host-screen {
      display:flex;
      flex-direction:row;
      gap:24px;
      align-items:stretch;
      height:100%;
      padding:24px;
      box-sizing:border-box;
    }
    .host-main {
      flex:2;
      background: linear-gradient(135deg, rgba(79,70,229,0.1), rgba(139,92,246,0.1));
      border-radius:20px;
      padding:40px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      border: 2px solid rgba(139,92,246,0.3);
      position: relative;
      overflow: hidden;
    }

    /* Millionenshow Style Counter */
    .countdown-badge {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 100px;
      height: 100px;
      background: conic-gradient(#10b981 0deg, #10b981 var(--progress), rgba(16,185,129,0.2) var(--progress), rgba(16,185,129,0.2) 360deg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 900;
      box-shadow: 0 8px 32px rgba(16,185,129,0.3);
      border: 3px solid rgba(255,255,255,0.2);
      z-index: 10;
    }

    .countdown-badge.warning {
      background: conic-gradient(#f59e0b 0deg, #f59e0b var(--progress), rgba(245,158,11,0.2) var(--progress), rgba(245,158,11,0.2) 360deg);
      box-shadow: 0 8px 32px rgba(245,158,11,0.3);
    }

    .countdown-badge.danger {
      background: conic-gradient(#ef4444 0deg, #ef4444 var(--progress), rgba(239,68,68,0.2) var(--progress), rgba(239,68,68,0.2) 360deg);
      box-shadow: 0 8px 32px rgba(239,68,68,0.3);
      animation: pulse-danger 0.5s infinite;
    }

    @keyframes pulse-danger {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Question Display */
    .question-container {
      width: 100%;
      padding: 30px;
      margin-bottom: 40px;
    }

    .question-text {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #ffffff, #e0e7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 50px;
      text-shadow: 0 4px 20px rgba(0,0,0,0.2);
      line-height: 1.2;
    }

    /* Answer Buttons Grid */
    .answers-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      width: 100%;
      max-width: 1200px;
    }

    .answer-btn {
      position: relative;
      padding: 30px;
      background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(139,92,246,0.3));
      border: 2px solid rgba(139,92,246,0.5);
      border-radius: 12px;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
      cursor: default;
      transition: all 0.3s ease;
      color: white;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.5px;
    }

    .answer-btn.highlighted {
      background: linear-gradient(135deg, rgba(16,185,129,0.6), rgba(34,197,94,0.6));
      border-color: rgba(16,185,129,0.8);
      box-shadow: 0 0 30px rgba(16,185,129,0.4);
      transform: scale(1.02);
    }

    /* Results Phase */
    .results-section {
      width: 100%;
    }

    .result-title {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 30px;
      color: #10b981;
    }

    .correct-answer {
      font-size: 2rem;
      margin-bottom: 40px;
      padding: 20px;
      background: rgba(16,185,129,0.2);
      border-left: 4px solid #10b981;
      border-radius: 8px;
    }

    .result-answer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      width: 100%;
    }

    .result-answer {
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid;
      font-weight: 600;
    }

    .result-answer.correct {
      background: rgba(16,185,129,0.2);
      border-left-color: #10b981;
    }

    .result-answer.incorrect {
      background: rgba(239,68,68,0.1);
      border-left-color: #ef4444;
    }

    .result-voters {
      font-size: 0.9rem;
      margin-top: 10px;
      color: rgba(255,255,255,0.8);
    }

    .host-side {
      flex:1;
      background: linear-gradient(135deg, rgba(79,70,229,0.05), rgba(139,92,246,0.05));
      border-radius:20px;
      padding:24px;
      overflow:auto;
      border: 2px solid rgba(139,92,246,0.2);
    }

    /* Leaderboard Styles */
    .leaderboard-title {
      font-size: 1.3rem;
      font-weight: 900;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #a78bfa;
    }

    .player-item {
      display: flex;
      justify-between;
      align-items: center;
      padding: 12px 15px;
      background: linear-gradient(90deg, rgba(139,92,246,0.2), rgba(79,70,229,0.1));
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #a78bfa;
      transition: all 0.2s ease;
    }

    .player-item:hover {
      background: linear-gradient(90deg, rgba(139,92,246,0.3), rgba(79,70,229,0.2));
      transform: translateX(5px);
    }

    .player-rank {
      font-weight: 900;
      font-size: 1.1rem;
      color: #fbbf24;
      margin-right: 10px;
      min-width: 25px;
    }

    .player-name {
      flex: 1;
      font-weight: 600;
    }

    .player-score {
      font-weight: 900;
      color: #10b981;
      font-size: 1.1rem;
    }

    /* Round Summary */
    .round-summary {
      text-align: center;
    }

    .summary-title {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .summary-podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      height: 300px;
      margin: 30px 0;
    }

    .podium-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .podium-player {
      text-align: center;
      margin-bottom: 10px;
    }

    .podium-name {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .podium-score {
      font-weight: 900;
      font-size: 1.4rem;
      color: #10b981;
    }

    .podium-bar {
      width: 100%;
      background: linear-gradient(180deg, rgba(139,92,246,0.6), rgba(79,70,229,0.3));
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      color: white;
      font-weight: 900;
      font-size: 2rem;
      border-top: 3px solid #a78bfa;
    }

    .podium-bar.gold {
      background: linear-gradient(180deg, rgba(251,191,36,0.8), rgba(217,119,6,0.4));
      border-top-color: #fbbf24;
      height: 250px;
    }

    .podium-bar.silver {
      background: linear-gradient(180deg, rgba(209,213,219,0.6), rgba(107,114,128,0.3));
      border-top-color: #d1d5db;
      height: 200px;
    }

    .podium-bar.bronze {
      background: linear-gradient(180deg, rgba(217,119,6,0.6), rgba(120,53,15,0.3));
      border-top-color: #d97706;
      height: 150px;
    }

    /* Game Finished */
    .finished-title {
      font-size: 3.5rem;
      font-weight: 900;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #10b981, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .finished-list {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-800 to-purple-700 text-white">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /************ CONFIG ************/
  const TOTAL_ROUNDS = 4;
  const QUESTIONS_PER_ROUND = 10;
  const QUESTION_TIME = 40; // Sekunden

  // --- Firebase Config: ERSETZE MIT DEINEN WERTEN ---
  const firebaseConfig = {
    apiKey: "AIzaSyCsxAEsivsJVFVcnerdAWezFpruoCv7Z2I",
            authDomain: "qiuz-64055.firebaseapp.com",
            databaseURL: "https://qiuz-64055-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "qiuz-64055",
            storageBucket: "qiuz-64055.firebasestorage.app",
            messagingSenderId: "605853616985",
            appId: "1:605853616985:web:95579b246a10d89ba51a48"
  };
  /********** END CONFIG **********/

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Pool mit Fragen (mindestens 40 sinnvoll). Erweitere bei Bedarf.
  const QUESTION_POOL = [
    { question: "Was ist die Hauptstadt von √ñsterreich?", answers: ["Wien","Graz","Salzburg","Innsbruck"], correct: 0 },
    { question: "Welcher Planet ist der gr√∂√üte?", answers: ["Mars","Saturn","Jupiter","Neptun"], correct: 2 },
    { question: "Wer malte die Mona Lisa?", answers: ["Picasso","Van Gogh","Da Vinci","Monet"], correct: 2 },
    { question: "In welchem Jahr fiel die Berliner Mauer?", answers: ["1987","1989","1991","1993"], correct: 1 },
    { question: "Was ist die chemische Formel f√ºr Wasser?", answers: ["CO2","H2O","O2","NaCl"], correct: 1 },
    { question: "Welches ist der l√§ngste Fluss der Welt?", answers: ["Nil","Amazonas","Yangtze","Mississippi"], correct: 0 },
    { question: "Wie viele Kontinente gibt es?", answers: ["5","6","7","8"], correct: 2 },
    { question: "Welches Tier ist das schnellste an Land?", answers: ["L√∂we","Gepard","Antilope","Pferd"], correct: 1 },
    { question: "Wer schrieb 'Romeo und Julia'?", answers: ["Goethe","Shakespeare","Schiller","Kafka"], correct: 1 },
    { question: "Welches ist das gr√∂√üte S√§ugetier?", answers: ["Elefant","Blauwal","Giraffe","Nilpferd"], correct: 1 },
    { question: "In welchem Land steht der Eiffelturm?", answers: ["Italien","Spanien","Frankreich","Deutschland"], correct: 2 },
    { question: "Was ist 7 x 8?", answers: ["54","56","58","64"], correct: 1 },
    { question: "Welche Farbe hat ein Smaragd?", answers: ["Rot","Blau","Gr√ºn","Gelb"], correct: 2 },
    { question: "Wie hei√üt die Hauptstadt von Deutschland?", answers: ["M√ºnchen","Hamburg","Berlin","K√∂ln"], correct: 2 },
    { question: "Welcher Ozean ist der gr√∂√üte?", answers: ["Atlantik","Indischer","Pazifik","Arktis"], correct: 2 },
    { question: "Wie viele Beine hat eine Spinne?", answers: ["6","8","10","12"], correct: 1 },
    { question: "Was ist die Hauptstadt der USA?", answers: ["New York","Los Angeles","Chicago","Washington D.C."], correct: 3 },
    { question: "Welches Instrument hat 88 Tasten?", answers: ["Gitarre","Klavier","Orgel","Keyboard"], correct: 1 },
    { question: "In welcher Stadt steht die Freiheitsstatue?", answers: ["Boston","New York","Chicago","Miami"], correct: 1 },
    { question: "Wie viele Seiten hat ein W√ºrfel?", answers: ["4","6","8","10"], correct: 1 },
    { question: "Welches Gas atmen wir ein?", answers: ["Sauerstoff","Stickstoff","Kohlendioxid","Helium"], correct: 0 },
    { question: "Wie hei√üt der h√∂chste Berg der Welt?", answers: ["K2","Mount Everest","Kilimandscharo","Mont Blanc"], correct: 1 },
    { question: "Welcher Planet ist der Erde am n√§chsten?", answers: ["Mars","Venus","Merkur","Jupiter"], correct: 1 },
    { question: "Wie viele Bundesl√§nder hat √ñsterreich?", answers: ["7","9","11","13"], correct: 1 },
    { question: "Was ist die Quadratwurzel von 64?", answers: ["6","8","10","12"], correct: 1 },
    { question: "Welches Tier legt Eier?", answers: ["Katze","Hund","Huhn","Kuh"], correct: 2 },
    { question: "Wie viele Minuten hat eine Stunde?", answers: ["30","45","60","90"], correct: 2 },
    { question: "Welche Farbe entsteht aus Rot und Gelb?", answers: ["Gr√ºn","Orange","Lila","Braun"], correct: 1 },
    { question: "In welchem Jahr begann das 21. Jahrhundert?", answers: ["1999","2000","2001","2002"], correct: 2 },
    { question: "Wie hei√üt die Hauptstadt von Spanien?", answers: ["Barcelona","Madrid","Valencia","Sevilla"], correct: 1 },
    { question: "Welches Element hat das Symbol 'Au'?", answers: ["Silber","Gold","Kupfer","Eisen"], correct: 1 },
    { question: "Welcher Fluss flie√üt durch London?", answers: ["Seine","Donau","Themse","Rhein"], correct: 2 },
    { question: "Was ist die kleinste Primzahl?", answers: ["0","1","2","3"], correct: 2 },
    { question: "Welches Land hat die meisten Einwohner?", answers: ["Indien","China","USA","Indonesien"], correct: 1 },
    { question: "Wie viele Spieler hat eine Fu√üballmannschaft auf dem Feld?", answers: ["9","10","11","12"], correct: 2 },
    { question: "Welche Sprache wird in Brasilien gesprochen?", answers: ["Spanisch","Portugiesisch","Franz√∂sisch","Englisch"], correct: 1 },
    { question: "Wie hei√üt das chemische Symbol f√ºr Wasserstoff?", answers: ["H","He","O","W"], correct: 0 },
    { question: "Was ist die Hauptstadt von Frankreich?", answers: ["Paris","Lyon","Marseille","Bordeaux"], correct: 0 },
    { question: "Wie viele Tage hat ein Schaltjahr?", answers: ["365","366","364","367"], correct: 1 },
    { question: "Was ist 12 √ó 12?", answers: ["144","124","132","156"], correct: 0 },
  ];

  // Hilfsfunktionen
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function generateQuestions() {
    const needed = TOTAL_ROUNDS * QUESTIONS_PER_ROUND;
    let pool = [...QUESTION_POOL];
    while (pool.length < needed) pool = pool.concat(QUESTION_POOL);
    pool = shuffle(pool).slice(0, needed).map((q, idx) => ({ id: idx, ...q }));
    return pool;
  }

  function randomGameID() {
    return Math.random().toString(36).substr(2,6).toUpperCase();
  }

  function makePlayerId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2,4);
  }

  // QuickChart QR URL
  function qrUrlForGame(gameId) {
    const url = `${window.location.origin}${window.location.pathname}?join=${gameId}`;
    return `https://quickchart.io/qr?text=${encodeURIComponent(url)}&size=300`;
  }

  /************ Components ************/

  // START SCREEN
  function StartScreen({ onCreate, onJoin }) {
    const [name, setName] = useState('');
    const [code, setCode] = useState('');

    return (
      <div className="min-h-screen flex items-center justify-center px-6">
        <div className="max-w-2xl w-full bg-white/5 p-6 rounded-xl">
          <h1 className="text-4xl font-bold mb-4">üéØ Multiplayer Quiz</h1>
          <p className="text-sm mb-4">Host erstellt Spiel (Quizmaster) oder Spieler treten per Code/QR bei.</p>

          <input className="w-full p-3 rounded mb-3 text-black" placeholder="Dein Name (wird im Spiel angezeigt)" value={name} onChange={e => setName(e.target.value)} />

          <div className="flex gap-3 mb-3">
            <button className="flex-1 bg-green-500 hover:bg-green-600 px-4 py-3 rounded font-bold disabled:opacity-60" disabled={!name} onClick={() => onCreate(name)}>Neues Spiel (Host)</button>
            <input className="w-40 p-2 rounded text-black" placeholder="Spielcode" value={code} onChange={e => setCode(e.target.value.toUpperCase())} />
            <button className="bg-blue-500 hover:bg-blue-600 px-3 py-3 rounded font-bold disabled:opacity-60" disabled={!name || !code} onClick={() => onJoin(name, code)}>Beitreten</button>
          </div>

          <p className="text-xs text-white/70">HINWEIS: Host ist nur Quizmaster und wird nicht als Spieler gez√§hlt.</p>
        </div>
      </div>
    );
  }

  function HostLobby({ gameId, hostName }) {
    const [players, setPlayers] = useState({});
    useEffect(() => {
      const ref = db.ref(`games/${gameId}/players`);
      ref.on('value', snap => setPlayers(snap.val() || {}));
      return () => ref.off();
    }, [gameId]);

    const startGame = async () => {
      const questions = generateQuestions();
      const metaObj = {
        phase: 'question',
        questionIndex: 0,
        round: 1,
        questionStartTime: Date.now(),
        nextQuestionIndex: null
      };
      await db.ref(`games/${gameId}/questions`).set(questions);
      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const updates = {};
      Object.keys(pObj).forEach(pid => {
        updates[`games/${gameId}/players/${pid}/score`] = 0;
        updates[`games/${gameId}/players/${pid}/currentAnswer`] = null;
      });
      await db.ref().update(updates);
      await db.ref(`games/${gameId}/meta`).set(metaObj);
    };

    return (
      <div className="min-h-screen host-screen">
        <div className="host-main">
          <h2 className="text-4xl font-bold mb-4">Quizmaster: {hostName}</h2>
          <div className="mb-4">
            <div className="text-xl mb-2">Spielcode: <span className="font-mono bg-white text-black px-3 py-1 rounded ml-2">{gameId}</span></div>
            <img src={qrUrlForGame(gameId)} alt="QR zum Joinen" className="mx-auto rounded-md shadow-md mb-3" />
            <div className="text-sm">Scanner den QR-Code mit dem Smartphone oder √∂ffne: <span className="underline">{window.location.origin + window.location.pathname}?join={gameId}</span></div>
          </div>

          <button className="bg-green-500 px-6 py-3 rounded text-xl font-bold mt-6" onClick={startGame}>
            Spiel starten
          </button>
        </div>

        <div className="host-side">
          <h3 className="leaderboard-title">Aktive Spieler</h3>
          <div className="space-y-2">
            {Object.entries(players).length === 0 && <div className="text-sm text-white/70">Keine Spieler</div>}
            {Object.entries(players).map(([pid,p], idx) => (
              <div key={pid} className="player-item">
                <div className="player-rank">#{idx+1}</div>
                <div className="player-name">{p.name}</div>
                <div className="player-score">{p.score || 0} pts</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // HOST CONTROLLER (kleine Steuerleiste)
  function HostController({ gameId, meta, startNextRound }) {
    const [players, setPlayers] = useState({});
    
    useEffect(() => {
      const ref = db.ref(`games/${gameId}/players`);
      ref.on('value', snap => setPlayers(snap.val() || {}));
      return () => ref.off();
    }, [gameId]);

    const startGame = async () => {
      const questions = generateQuestions();
      const metaObj = {
        phase: 'question',
        questionIndex: 0,
        round: 1,
        questionStartTime: Date.now(),
        nextQuestionIndex: null
      };
      await db.ref(`games/${gameId}/questions`).set(questions);
      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const updates = {};
      Object.keys(pObj).forEach(pid => {
        updates[`games/${gameId}/players/${pid}/score`] = 0;
        updates[`games/${gameId}/players/${pid}/currentAnswer`] = null;
      });
      await db.ref().update(updates);
      await db.ref(`games/${gameId}/meta`).set(metaObj);
    };

    const showResultsNow = async () => {
      try {
        const snap = await db.ref(`games/${gameId}`).get();
        const g = snap.val();
        if (!g) return;
        const qIndex = g.meta?.questionIndex || 0;
        const q = (g.questions || [])[qIndex];
        if (!q) return;
        const playerObj = g.players || {};
        const updates = {};
        Object.entries(playerObj).forEach(([pid,p]) => {
          const ans = p.currentAnswer;
          const correct = typeof ans === 'number' && ans === q.correct;
          const newScore = (p.score || 0) + (correct ? 100 : 0);
          updates[`games/${gameId}/players/${pid}/score`] = newScore;
        });
        await db.ref().update(updates);
        await db.ref(`games/${gameId}/meta`).update({ phase: 'results' });
      } catch (err) { console.error(err); }
    };

    const nextQuestion = async () => {
      const snap = await db.ref(`games/${gameId}/meta`).get();
      const metaVal = snap.val();
      const cur = metaVal?.questionIndex || 0;
      const next = cur + 1;
      const isGameEnd = next >= TOTAL_ROUNDS * QUESTIONS_PER_ROUND;
      const isEndOfRound = (cur + 1) % QUESTIONS_PER_ROUND === 0;

      if (isGameEnd) {
        await db.ref(`games/${gameId}/meta`).update({ phase: 'finished' });
      } else if (isEndOfRound) {
        await db.ref(`games/${gameId}/meta`).update({ phase: 'roundSummary', nextQuestionIndex: next });
      } else {
        const pSnap = await db.ref(`games/${gameId}/players`).get();
        const pObj = pSnap.val() || {};
        const updates = {};
        Object.keys(pObj).forEach(pid => updates[`games/${gameId}/players/${pid}/currentAnswer`] = null);
        await db.ref().update(updates);
        await db.ref(`games/${gameId}/meta`).update({
          questionIndex: next,
          phase: 'question',
          questionStartTime: Date.now(),
          round: Math.floor(next / QUESTIONS_PER_ROUND) + 1
        });
      }
    };

    if (!meta) {
      return <div className="text-center p-3 text-white/70">Warten auf Spielmeta...</div>;
    }

    return (
      <div className="space-y-3">
        <div className="flex items-center justify-between mb-4">
          <div>
            <div className="text-sm text-white/90">Phase: <strong>{meta.phase}</strong></div>
            <div className="text-sm text-white/90">Runde: <strong>{meta.round || 1}/{TOTAL_ROUNDS}</strong></div>
            <div className="text-sm text-white/90">Frage: <strong>{(meta.questionIndex || 0) + 1}/{TOTAL_ROUNDS * QUESTIONS_PER_ROUND}</strong></div>
          </div>
          <div className="text-right">
            <div className="text-xs text-white/80">üë• Spieler: {Object.keys(players).length}</div>
          </div>
        </div>

        <div className="flex gap-2 flex-wrap">
          { (meta.phase === 'lobby' || !meta.phase) && <button className="bg-green-500 hover:bg-green-600 px-4 py-2 rounded text-sm font-bold" onClick={startGame}>Spiel starten</button> }
          { meta.phase === 'question' && <button className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded text-sm font-bold" onClick={showResultsNow}>Ergebnisse anzeigen</button> }
          { meta.phase === 'results' && <button className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-bold" onClick={nextQuestion}>N√§chste Frage</button> }
          { meta.phase === 'roundSummary' && <button className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-bold" onClick={startNextRound}>N√§chste Runde</button> }
          { meta.phase === 'finished' && <div className="text-green-300 font-bold px-3 py-2 rounded text-sm">‚úì Spiel beendet</div> }
        </div>
      </div>
    );
  }

  // HOST FULLSCREEN VIEW (gro√ües Panel f√ºr TV/Beamer)
  function HostScreen({ gameId, hostName }) {
    const [game, setGame] = useState(null);
    const [meta, setMeta] = useState(null);
    const [timeLeft, setTimeLeft] = useState(0);
    const timerRef = useRef(null);

    useEffect(() => {
      const gRef = db.ref(`games/${gameId}`);
      gRef.on('value', snap => setGame(snap.val()));
      const mRef = db.ref(`games/${gameId}/meta`);
      mRef.on('value', snap => setMeta(snap.val()));
      return () => { gRef.off(); mRef.off(); clearInterval(timerRef.current); };
    }, [gameId]);

    useEffect(() => {
      if (!meta || meta.phase !== 'question' || !meta.questionStartTime) { setTimeLeft(0); return; }
      const tick = () => {
        const elapsed = Math.floor((Date.now() - meta.questionStartTime) / 1000);
        const rem = Math.max(0, QUESTION_TIME - elapsed);
        setTimeLeft(rem);
      };
      tick();
      clearInterval(timerRef.current);
      timerRef.current = setInterval(tick, 500);
      return () => clearInterval(timerRef.current);
    }, [meta?.phase, meta?.questionStartTime]);

    const startNextRound = async () => {
      if (!meta) return;
      const nextIndex = meta.nextQuestionIndex ?? (meta.questionIndex ?? 0);
      const round = Math.floor(nextIndex / QUESTIONS_PER_ROUND) + 1;
      const pSnap = await db.ref(`games/${gameId}/players`).get();
      const pObj = pSnap.val() || {};
      const updates = {};
      Object.keys(pObj).forEach(pid => updates[`games/${gameId}/players/${pid}/currentAnswer`] = null);
      await db.ref().update(updates);
      await db.ref(`games/${gameId}/meta`).update({
        questionIndex: nextIndex,
        phase: 'question',
        questionStartTime: Date.now(),
        round: round,
        nextQuestionIndex: null
      });
    };

    if (!meta || !game) return <div className="min-h-screen flex items-center justify-center">Lade Spiel...</div>;

    const qIndex = meta.questionIndex || 0;
    const question = (game.questions || [])[qIndex];
    const playersArr = Object.entries(game.players || {}).map(([pid,p]) => ({ pid, ...p })).sort((a,b) => (b.score || 0) - (a.score || 0));

    // Berechne Countdown-Progress f√ºr die CSS-Animation
    const countdownProgress = (timeLeft / QUESTION_TIME) * 360;
    const countdownClass = timeLeft <= 10 ? 'danger' : timeLeft <= 20 ? 'warning' : '';

    return (
      <div className="min-h-screen host-screen">
        <div className="host-main">
          { meta.phase === 'lobby' && (
            <div>
              <h2 className="text-5xl font-bold mb-2">‚è≥ Warte auf Spieler</h2>
              <p className="text-2xl mt-8">Spielcode:</p>
              <p className="font-mono bg-white text-black px-6 py-2 rounded text-3xl font-bold mt-2">{gameId}</p>
            </div>
          )}

          { meta.phase === 'question' && question && (
            <div className="question-container">
              <div 
                className={`countdown-badge ${countdownClass}`}
                style={{'--progress': `${countdownProgress}deg`}}
              >
                {timeLeft}
              </div>
              <div className="question-text">{question.question}</div>
              <div className="answers-grid">
                {question.answers.map((a, i) => (
                  <div key={i} className="answer-btn">
                    <span>{String.fromCharCode(65+i)}. {a}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          { meta.phase === 'results' && question && (
            <div className="results-section">
              <h2 className="result-title">üìä Ergebnisse</h2>
              <div className="correct-answer">
                ‚úì Richtige Antwort: <strong>{question.answers[question.correct]}</strong>
              </div>
              <div className="result-answer-grid">
                {question.answers.map((a, i) => {
                  const voters = playersArr.filter(p => p.currentAnswer === i);
                  const isCorrect = i === question.correct;
                  return (
                    <div key={i} className={`result-answer ${isCorrect ? 'correct' : 'incorrect'}`}>
                      <div className="font-bold">{String.fromCharCode(65+i)}. {a}</div>
                      <div className="result-voters">
                        {voters.length > 0 ? voters.map(p => p.name).join(', ') : '(Niemand)'}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          { meta.phase === 'roundSummary' && (
            <div className="round-summary">
              <h2 className="summary-title">üèÜ Zwischenstand Runde {meta.round}</h2>
              <div className="summary-podium">
                {playersArr.slice(0, 3).map((p, i) => {
                  const podiumClass = i === 0 ? 'gold' : i === 1 ? 'silver' : 'bronze';
                  const position = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â';
                  return (
                    <div key={p.pid} className="podium-item">
                      <div className="podium-player">
                        <div className="text-3xl">{position}</div>
                        <div className="podium-name">{p.name}</div>
                        <div className="podium-score">{p.score || 0} Pts</div>
                      </div>
                      <div className={`podium-bar ${podiumClass}`}>
                        {p.score || 0}
                      </div>
                    </div>
                  );
                })}
              </div>
              {playersArr.length > 3 && (
                <div className="mt-8">
                  {playersArr.slice(3).map((p, i) => (
                    <div key={p.pid} className="flex justify-between items-center p-3 bg-white/5 rounded mb-2">
                      <div className="text-lg font-bold">#{i+4} {p.name}</div>
                      <div className="text-lg font-bold text-green-400">{p.score || 0} pts</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          { meta.phase === 'finished' && (
            <div>
              <h2 className="finished-title">üéâ Spiel beendet!</h2>
              <div className="finished-list">
                {playersArr.map((p, i) => (
                  <div key={p.pid} className="flex justify-between items-center bg-white/5 p-4 rounded mb-3 border-l-4 border-purple-500">
                    <div className="text-2xl font-bold">#{i+1} {p.name}</div>
                    <div className="text-2xl font-extrabold text-green-400">{p.score || 0} pts</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        <div className="host-side">
          <div className="mb-6">
            <HostController gameId={gameId} meta={meta} startNextRound={startNextRound} />
          </div>

          <div className="mb-6">
            <h3 className="leaderboard-title">üèÖ Spieler & Punkte</h3>
            <div className="space-y-2 max-h-72 overflow-auto">
              {playersArr.map((p, idx) => (
                <div key={p.pid} className="player-item">
                  <div className="player-rank">#{idx+1}</div>
                  <div className="player-name text-sm">{p.name}</div>
                  <div className="player-score text-sm">{p.score || 0}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="mb-6">
            <h3 className="leaderboard-title">‚ÑπÔ∏è Spiel-Info</h3>
            <div className="text-sm bg-white/5 p-3 rounded mb-2">Code: <span className="font-mono bg-white text-black px-2 py-1 rounded text-xs">{gameId}</span></div>
            <img src={qrUrlForGame(gameId)} alt="QR Code" className="w-full rounded" />
          </div>

          <div>
            <h3 className="leaderboard-title">üìã Anleitung</h3>
            <ol className="text-xs list-decimal list-inside space-y-1 bg-white/5 p-3 rounded">
              <li>QR-Code oder Code eingeben</li>
              <li>40s Zeit zum Antworten</li>
              <li>Host zeigt Ergebnisse</li>
              <li>Zwischenstand nach Runde</li>
            </ol>
          </div>
        </div>
      </div>
    );
  }

  // PLAYER VIEW (Smartphone)
  function PlayerView({ gameId, playerId }) {
    const [game, setGame] = useState(null);
    const [meta, setMeta] = useState(null);
    const [player, setPlayer] = useState(null);
    const [timeLeft, setTimeLeft] = useState(0);

    useEffect(() => {
      const gRef = db.ref(`games/${gameId}`);
      gRef.on('value', snap => setGame(snap.val()));
      const mRef = db.ref(`games/${gameId}/meta`);
      mRef.on('value', snap => setMeta(snap.val()));
      const pRef = db.ref(`games/${gameId}/players/${playerId}`);
      pRef.on('value', snap => setPlayer(snap.val()));
      return () => { gRef.off(); mRef.off(); pRef.off(); };
    }, [gameId, playerId]);

    useEffect(() => {
      if (!meta || meta.phase !== 'question' || !meta.questionStartTime) { setTimeLeft(0); return; }
      const tick = () => {
        const elapsed = Math.floor((Date.now() - meta.questionStartTime) / 1000);
        setTimeLeft(Math.max(0, QUESTION_TIME - elapsed));
      };
      tick();
      const t = setInterval(tick, 500);
      return () => clearInterval(t);
    }, [meta?.questionStartTime, meta?.phase]);

    if (!game || !meta || !player) return <div className="min-h-screen flex items-center justify-center">Warte auf Spiel...</div>;

    const qIndex = meta.questionIndex || 0;
    const question = (game.questions || [])[qIndex];

    if (meta.phase === 'lobby') {
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white/5 p-6 rounded w-full max-w-md text-center">
            <h2 className="text-2xl font-bold mb-2">Warte auf Start</h2>
            <p className="mb-2">Spielcode: <span className="font-mono bg-white text-black px-2 py-1 rounded">{gameId}</span></p>
            <p className="text-sm">Bitte warte, bis der Host das Spiel startet.</p>
            <p className="text-sm mt-3">Dein Name: <strong>{player.name}</strong></p>
          </div>
        </div>
      );
    }

    if (meta.phase === 'question' && question) {
      const hasAnswered = player.currentAnswer !== null && player.currentAnswer !== undefined;
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white/5 p-6 rounded w-full max-w-md">
            <div className="flex justify-between items-center mb-4">
              <div>Runde {meta.round}/{TOTAL_ROUNDS}</div>
              <div className="text-lg font-bold">{timeLeft}s</div>
            </div>
            <h3 className="text-xl font-bold mb-4">{question.question}</h3>

            <div className="grid gap-3">
              {question.answers.map((ans,i) => {
                const disabled = hasAnswered || timeLeft <= 0;
                const isSelected = player.currentAnswer === i;
                return (
                  <button
                    key={i}
                    disabled={disabled}
                    onClick={() => db.ref(`games/${gameId}/players/${playerId}/currentAnswer`).set(i)}
                    className={`p-3 rounded font-bold text-left ${disabled ? (isSelected ? 'bg-green-500 text-white' : 'bg-white/10 text-white/80') : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                  >
                    {String.fromCharCode(65+i)}. {ans}
                  </button>
                );
              })}
            </div>

            <div className="mt-4 text-sm">
              {player.currentAnswer === null ? "Noch nicht geantwortet" : `Du hast Antwort ${String.fromCharCode(65 + player.currentAnswer)} gew√§hlt`}
            </div>
            <div className="mt-4 text-sm">Punkte: <strong>{player.score || 0}</strong></div>
          </div>
        </div>
      );
    }

    if (meta.phase === 'results' && question) {
      const wasCorrect = player.currentAnswer === question.correct;
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white/5 p-6 rounded w-full max-w-md text-center">
            <h3 className="text-3xl font-bold mb-3">{wasCorrect ? 'Richtig! üéâ' : 'Falsch üòï'}</h3>
            <p className="mb-2">Richtige Antwort: <strong>{question.answers[question.correct]}</strong></p>
            <p className="mb-2">Dein Punktestand: <strong>{player.score || 0}</strong></p>
            <p className="text-sm">Warte auf den Host f√ºr die n√§chste Frage.</p>
          </div>
        </div>
      );
    }

    if (meta.phase === 'roundSummary') {
      const playersSorted = Object.values(game.players || {}).sort((a,b) => (b.score||0)-(a.score||0));
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white/5 p-6 rounded w-full max-w-md">
            <h3 className="text-2xl font-bold mb-3">Zwischenstand Runde {meta.round}</h3>
            <div className="bg-white/10 p-3 rounded mb-3">
              {playersSorted.map((p,i) => <div key={i} className="flex justify-between py-1">{i+1}. {p.name} <span>{p.score||0} pts</span></div>)}
            </div>
            <p className="text-sm">Host startet die n√§chste Runde, sobald er bereit ist.</p>
          </div>
        </div>
      );
    }

    if (meta.phase === 'finished') {
      const playersSorted = Object.values(game.players || {}).sort((a,b) => (b.score||0)-(a.score||0));
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white/5 p-6 rounded w-full max-w-md">
            <h3 className="text-3xl font-bold mb-3">Spiel beendet</h3>
            <div className="bg-white/10 p-3 rounded mb-3">
              {playersSorted.map((p,i) => <div key={i} className="flex justify-between py-1">{i+1}. {p.name} <span>{p.score||0} pts</span></div>)}
            </div>
          </div>
        </div>
      );
    }

    return <div>Warte...</div>;
  }

  // Player Join Screen when opening with ?join=CODE
  function PlayerJoin({ joinGameId, onJoined }) {
    const [name, setName] = useState('');
    const [error, setError] = useState('');

    const handleJoin = async () => {
      setError('');
      try {
        const snap = await db.ref(`games/${joinGameId}`).get();
        if (!snap.exists()) { setError('Spiel nicht gefunden'); return; }
        const pid = makePlayerId();
        const playerObj = { name, score: 0, currentAnswer: null, joinedAt: Date.now() };
        await db.ref(`games/${joinGameId}/players/${pid}`).set(playerObj);
        localStorage.setItem(`quiz_player_${joinGameId}`, pid);
        localStorage.setItem(`quiz_name_${joinGameId}`, name);
        onJoined(joinGameId, pid, name);
      } catch (err) { console.error(err); setError('Fehler beim Beitreten'); }
    };

    return (
      <div className="min-h-screen flex items-center justify-center p-6">
        <div className="bg-white/5 p-6 rounded w-full max-w-md">
          <h2 className="text-2xl font-bold mb-3">Spiel beitreten: {joinGameId}</h2>
          <input className="w-full p-3 rounded mb-3 text-black" placeholder="Dein Name" value={name} onChange={e => setName(e.target.value)} />
          <button className="bg-blue-500 px-4 py-3 rounded w-full font-bold" onClick={handleJoin} disabled={!name}>Beitreten</button>
          {error && <div className="text-red-300 mt-3">{error}</div>}
        </div>
      </div>
    );
  }

  /************ App (Single File) ************/
  function App() {
    const [mode, setMode] = useState('start');
    const [gameId, setGameId] = useState('');
    const [playerId, setPlayerId] = useState('');
    const [playerName, setPlayerName] = useState('');
    const [hostName, setHostName] = useState('');
    const [isHost, setIsHost] = useState(false);

    useEffect(() => {
      const params = new URLSearchParams(window.location.search);
      const join = params.get('join');
      if (join) {
        setGameId(join.toUpperCase());
        setMode('player-join');
      }
    }, []);

    const createGame = async (host) => {
      const id = randomGameID();
      const questions = generateQuestions();
      const meta = {
        phase: 'lobby',
        questionIndex: 0,
        round: 1,
        questionStartTime: null,
        nextQuestionIndex: null
      };
      const gameObj = { host, questions, meta, players: {} };
      await db.ref(`games/${id}`).set(gameObj);
      setGameId(id);
      setHostName(host);
      setIsHost(true);
      setMode('host-lobby');
    };

    const joinGameFromStart = async (name, id) => {
      const snap = await db.ref(`games/${id}`).get();
      if (!snap.exists()) { alert('Spiel nicht gefunden'); return; }
      const pid = makePlayerId();
      await db.ref(`games/${id}/players/${pid}`).set({ name, score: 0, currentAnswer: null, joinedAt: Date.now() });
      localStorage.setItem(`quiz_player_${id}`, pid);
      localStorage.setItem(`quiz_name_${id}`, name);
      setGameId(id);
      setPlayerId(pid);
      setPlayerName(name);
      setIsHost(false);
      setMode('player-play');
    };

    const onJoined = (id, pid, name) => {
      setGameId(id);
      setPlayerId(pid);
      setPlayerName(name);
      setIsHost(false);
      setMode('player-play');
    };

    useEffect(() => {
      if (mode !== 'player-join') return;
      if (!gameId) return;
      const storedPid = localStorage.getItem(`quiz_player_${gameId}`);
      const storedName = localStorage.getItem(`quiz_name_${gameId}`);
      if (storedPid && storedName) {
        db.ref(`games/${gameId}/players/${storedPid}`).get().then(snap => {
          if (!snap.exists()) {
            db.ref(`games/${gameId}/players/${storedPid}`).set({ name: storedName, score: 0, currentAnswer: null, joinedAt: Date.now() });
          }
          setPlayerId(storedPid);
          setPlayerName(storedName);
          setMode('player-play');
        }).catch(err => console.error(err));
      }
    }, [mode, gameId]);

    useEffect(() => {
      if (mode !== 'host-lobby') return;
      const ref = db.ref(`games/${gameId}/meta`);
      const handler = (snap) => {
        const val = snap.val();
        if (!val) return;
        if (val.phase && val.phase !== 'lobby') {
          setMode('host-screen');
        }
      };
      ref.on('value', handler);
      return () => ref.off('value', handler);
    }, [mode, gameId]);

    if (mode === 'start') {
      return <StartScreen onCreate={(host) => createGame(host)} onJoin={(name, code) => joinGameFromStart(name, code)} />;
    }

    if (mode === 'host-lobby') {
      return <HostLobby gameId={gameId} hostName={hostName} />;
    }

    if (mode === 'host-screen') {
      return <HostScreen gameId={gameId} hostName={hostName} />;
    }

    if (mode === 'player-join') {
      return <PlayerJoin joinGameId={gameId} onJoined={onJoined} />;
    }

    if (mode === 'player-play') {
      return <PlayerView gameId={gameId} playerId={playerId} />;
    }

    return <div>...</div>;
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
